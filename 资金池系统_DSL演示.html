<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>资金池管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        /* 整体布局 */
        .layout {
            display: flex;
            height: 100vh;
        }

        /* 左侧导航栏 */
        .sidebar {
            width: 200px;
            background: #304156;
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-item.active {
            background: #409eff;
        }

        /* 主内容区 */
        .main-content {
            margin-left: 200px;
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* 面包屑 */
        .breadcrumb {
            font-size: 14px;
            color: #666;
            margin-bottom: 20px;
        }

        /* 筛选工具栏 */
        .toolbar {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .toolbar-row {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 0;
        }

        .filter-item {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }

        .filter-item label {
            font-size: 14px;
            color: #666;
            margin-right: 10px;
            white-space: nowrap;
        }

        .filter-item select,
        .filter-item input {
            width: 120px;
            height: 36px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 0 12px;
            font-size: 14px;
        }

        .filter-item select.main-project {
            width: 150px;
        }

        .filter-item select.sub-project {
            width: 150px;
        }

        .btn-query {
            width: 80px;
            height: 36px;
            background: #409eff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 15px;
            font-size: 14px;
        }

        .btn-reset {
            width: 80px;
            height: 36px;
            background: #e0e0e0;
            color: #666;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
        }

        /* 表格 */
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            height: 48px;
            padding: 0 15px;
            font-size: 14px;
            font-weight: bold;
            color: #666;
            text-align: left;
        }

        th.col-id {
            width: 120px;
        }

        th.col-main {
            width: 150px;
        }

        th.col-sub {
            width: 200px;
        }

        th.col-number {
            width: 130px;
            text-align: right;
        }

        th.col-days {
            width: 100px;
            text-align: right;
        }

        th.col-apy {
            width: 120px;
            text-align: right;
        }

        th.col-status {
            width: 120px;
            text-align: center;
        }

        th.col-manager {
            width: 100px;
        }

        th.col-action {
            width: 120px;
            text-align: center;
        }

        td {
            height: 48px;
            padding: 0 15px;
            font-size: 14px;
            border-bottom: 1px solid #e9ecef;
        }

        td.text-right {
            text-align: right;
        }

        td.text-center {
            text-align: center;
        }

        tbody tr:hover {
            background: #f8f9fa;
            cursor: pointer;
        }

        /* 徽章 */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-info {
            background: #409eff;
            color: white;
        }

        .badge-warning {
            background: #e6a23c;
            color: white;
        }

        .badge-success {
            background: #10b981;
            color: white;
        }

        .badge-secondary {
            background: #909399;
            color: white;
        }

        .badge-reminder {
            background: #fef3c7;
            color: #92400e;
            margin-left: 10px;
        }

        .badge-normal {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .text-red {
            color: #ef4444;
        }

        .text-green {
            color: #10b981;
        }

        .link-btn {
            color: #409eff;
            text-decoration: underline;
            cursor: pointer;
        }

        /* 分页 */
        .pagination {
            background: white;
            padding: 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pagination-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pagination-left span {
            font-size: 14px;
            color: #666;
        }

        .pagination-left select {
            width: 80px;
            height: 32px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0 8px;
        }

        .pagination-center {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .pagination-center button {
            width: 32px;
            height: 32px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .pagination-center button.active {
            background: #409eff;
            color: white;
            border-color: #409eff;
        }

        .pagination-center span {
            margin: 0 5px;
        }

        .pagination-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pagination-right span {
            font-size: 14px;
            color: #666;
        }

        .pagination-right input {
            width: 60px;
            height: 32px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0 8px;
            text-align: center;
        }

        /* 详情页 */
        .detail-page {
            display: none;
        }

        .detail-page.active {
            display: block;
        }

        .back-btn {
            background: #e0e0e0;
            color: #666;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .detail-header {
            background: white;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .detail-header h1 {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .detail-header .subtitle {
            font-size: 14px;
            color: #666;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .info-card h3 {
            font-size: 16px;
            font-weight: bold;
            color: #666;
            padding-bottom: 10px;
            border-bottom: 2px solid #409eff;
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            height: 40px;
            align-items: center;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #999;
            font-size: 14px;
        }

        .info-value {
            font-weight: bold;
            font-size: 14px;
        }

        .coin-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-top: 20px;
        }

        .coin-table-header {
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .coin-table-header h3 {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            z-index: 1001;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .form-group label .required {
            color: #ef4444;
            margin-left: 4px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #409eff;
            box-shadow: 0 0 0 3px rgba(64, 158, 255, 0.1);
        }

        .form-group input[disabled],
        .form-group select[disabled] {
            background: #f5f7fa;
            color: #999;
            cursor: not-allowed;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"] {
            width: auto;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-warning {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            color: #92400e;
        }

        .alert-danger {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
        }

        .alert-info {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            color: #1e40af;
        }

        .alert-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .alert-content {
            font-size: 13px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary {
            background: #409eff;
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 页面切换 */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .btn-success {
            background: #67c23a;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-warning {
            background: #e6a23c;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="layout">
        <!-- 左侧导航栏 -->
        <div class="sidebar">
            <div class="sidebar-item">总投资产</div>
            <div class="sidebar-item">交易所</div>
            <div class="sidebar-item">钱包管理</div>
            <div class="sidebar-item">用户管理</div>
            <div class="sidebar-item">项目管理</div>
            <div class="sidebar-item">工具</div>
            <div class="sidebar-item">Metamask</div>
            <div class="sidebar-item">信息监控</div>
            <div class="sidebar-item active">对账管理</div>
            <div class="sidebar-item" style="padding-left: 40px;" onclick="showPage('advanceFundingPage')">项目垫资</div>
            <div class="sidebar-item" style="padding-left: 40px;" onclick="showPage('fundsPoolPage')">资金池</div>
            <div class="sidebar-item" style="padding-left: 40px;" onclick="showPage('auditPage')">项目审计</div>
            <div class="sidebar-item" style="padding-left: 40px;">资金池账户概览</div>
            <div class="sidebar-item">Buildpad账号</div>
        </div>

        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 项目垫资列表页 -->
            <div id="advanceFundingPage" class="page">
                <div class="breadcrumb">Dashboard / 对账管理 / 项目垫资</div>

                <!-- 筛选工具栏 -->
                <div class="toolbar">
                    <div class="toolbar-row" style="justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 0;">
                            <div class="filter-item">
                                <input type="text" placeholder="搜索" style="width: 150px;">
                            </div>
                            <div class="filter-item">
                                <label>所属主项目</label>
                                <select style="width: 150px;">
                                    <option>全部</option>
                                    <option>Opinion</option>
                                    <option>Gensyn</option>
                                    <option>Aster一期</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label>所属子项目</label>
                                <select style="width: 150px;">
                                    <option>全部</option>
                                    <option>Opinion-wave圣诞节活动</option>
                                    <option>gensyn_bid</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label>状态</label>
                                <select style="width: 120px;">
                                    <option>全部</option>
                                    <option>已审核</option>
                                    <option>待审核</option>
                                    <option>已取消</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label>类型</label>
                                <select style="width: 120px;">
                                    <option>全部</option>
                                    <option>项目垫资</option>
                                    <option>项目还款</option>
                                    <option>空投归集</option>
                                </select>
                            </div>
                            <button class="btn-query">查询</button>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="openModal('createModal')">创建新项目</button>
                            <button class="btn btn-success" onclick="openModal('advanceModal')">申请项目垫资</button>
                            <button class="btn btn-warning" onclick="openModal('repaymentModal')">申请项目还款</button>
                        </div>
                    </div>
                </div>

                <!-- 数据表格 -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 100px;">唯一标识</th>
                                <th style="width: 150px;">申请事项</th>
                                <th style="width: 120px;">所属主项目</th>
                                <th style="width: 180px;">所属子项目</th>
                                <th style="width: 80px;">币种</th>
                                <th style="width: 120px; text-align: right;">金额</th>
                                <th style="width: 80px;">链</th>
                                <th style="width: 100px;">类型</th>
                                <th style="width: 100px; text-align: center;">状态</th>
                                <th style="width: 100px;">申请人</th>
                                <th style="width: 160px;">申请时间</th>
                                <th style="width: 100px;">审核人</th>
                                <th style="width: 160px;">审核时间</th>
                                <th style="width: 150px;">备注</th>
                                <th style="width: 150px; text-align: center;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="advanceFundingTableBody">
                            <tr>
                                <td>H441</td>
                                <td>测试项目</td>
                                <td>测试主项目</td>
                                <td>测试子项目</td>
                                <td>usdt</td>
                                <td class="text-right">5000</td>
                                <td>bsc</td>
                                <td>项目垫资</td>
                                <td class="text-center"><span class="badge badge-success">已审核</span></td>
                                <td>张三</td>
                                <td>2025-01-15T10:00:00</td>
                                <td>admin</td>
                                <td>2025-01-15T10:15:00</td>
                                <td>-</td>
                                <td class="text-center">
                                    <span class="link-btn" onclick="event.stopPropagation(); openModal('repaymentModal', '测试主项目', '测试子项目')" style="margin-right: 10px;">申请还款/空投</span>
                                    <span class="link-btn">取消</span>
                                </td>
                            </tr>
                            <tr>
                                <td>D438</td>
                                <td>100个号垫资</td>
                                <td>Opinion</td>
                                <td>Opinion-wave圣诞节活动</td>
                                <td>usdt</td>
                                <td class="text-right">61000</td>
                                <td>bsc</td>
                                <td>项目垫资</td>
                                <td class="text-center"><span class="badge badge-success">已审核</span></td>
                                <td>siri</td>
                                <td>2025-12-25T15:37:12</td>
                                <td>admin</td>
                                <td>2025-12-25T15:57:51</td>
                                <td>-</td>
                                <td class="text-center">
                                    <span class="link-btn" onclick="event.stopPropagation(); openModal('repaymentModal', 'Opinion', 'Opinion-wave圣诞节活动')" style="margin-right: 10px;">申请还款/空投</span>
                                    <span class="link-btn">取消</span>
                                </td>
                            </tr>
                            <tr>
                                <td>D437</td>
                                <td>空投收益归集</td>
                                <td>Aster一期</td>
                                <td>Aster一期-打新</td>
                                <td>usdt</td>
                                <td class="text-right">15000</td>
                                <td>bsc</td>
                                <td>空投归集</td>
                                <td class="text-center"><span class="badge badge-success">已审核</span></td>
                                <td>王五</td>
                                <td>2025-02-13T10:00:00</td>
                                <td>admin</td>
                                <td>2025-02-13T10:30:00</td>
                                <td>空投收益到账</td>
                                <td class="text-center">
                                    <span class="link-btn" onclick="event.stopPropagation(); openModal('repaymentModal', 'Aster一期', 'Aster一期-打新')" style="margin-right: 10px;">申请还款/空投</span>
                                    <span class="link-btn">取消</span>
                                </td>
                            </tr>
                            <tr>
                                <td>D436</td>
                                <td>ETH还款</td>
                                <td>Gensyn</td>
                                <td>gensyn_bid</td>
                                <td>eth</td>
                                <td class="text-right">0.3</td>
                                <td>eth</td>
                                <td>项目还款</td>
                                <td class="text-center"><span class="badge badge-success">已审核</span></td>
                                <td>李四</td>
                                <td>2025-12-20T14:20:00</td>
                                <td>admin</td>
                                <td>2025-12-20T14:35:00</td>
                                <td>部分还款</td>
                                <td class="text-center">
                                    <span class="link-btn" onclick="event.stopPropagation(); openModal('repaymentModal', 'Gensyn', 'gensyn_bid')" style="margin-right: 10px;">申请还款/空投</span>
                                    <span class="link-btn">取消</span>
                                </td>
                            </tr>
                            <tr>
                                <td>D435</td>
                                <td>ETH垫资</td>
                                <td>Gensyn</td>
                                <td>gensyn_bid</td>
                                <td>eth</td>
                                <td class="text-right">0.5</td>
                                <td>eth</td>
                                <td>项目垫资</td>
                                <td class="text-center"><span class="badge badge-success">已审核</span></td>
                                <td>李四</td>
                                <td>2025-12-20T10:00:00</td>
                                <td>admin</td>
                                <td>2025-12-20T10:15:00</td>
                                <td>ETH垫资</td>
                                <td class="text-center">
                                    <span class="link-btn" onclick="event.stopPropagation(); openModal('repaymentModal', 'Gensyn', 'gensyn_bid')" style="margin-right: 10px;">申请还款/空投</span>
                                    <span class="link-btn">取消</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <div class="pagination">
                    <div class="pagination-left">
                        <span>共 391 条</span>
                        <select>
                            <option>10条/页</option>
                            <option>20条/页</option>
                            <option>50条/页</option>
                        </select>
                    </div>
                    <div class="pagination-center">
                        <button>&lt;</button>
                        <button class="active">1</button>
                        <button>2</button>
                        <button>3</button>
                        <button>4</button>
                        <button>5</button>
                        <button>6</button>
                        <span>...</span>
                        <button>40</button>
                        <button>&gt;</button>
                    </div>
                    <div class="pagination-right">
                        <span>前往</span>
                        <input type="number" value="1">
                        <span>页</span>
                    </div>
                </div>
            </div>

            <!-- 资金池列表页 -->
            <div id="fundsPoolPage" class="page">
                <div class="breadcrumb">Dashboard / 对账管理 / 资金池</div>

                <!-- 筛选工具栏 -->
                <div class="toolbar">
                    <div class="toolbar-row">
                        <div class="filter-item">
                            <label>负责人</label>
                            <select>
                                <option>全部</option>
                                <option>张三</option>
                                <option>李四</option>
                                <option>王五</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>所属主项目</label>
                            <select class="main-project">
                                <option>全部</option>
                                <option>Opinion</option>
                                <option>Gensyn</option>
                                <option>Aster一期</option>
                                <option>Aster二期</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>所属子项目</label>
                            <select class="sub-project">
                                <option>全部</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>状态</label>
                            <select>
                                <option>全部</option>
                                <option>进行中</option>
                                <option>待审计</option>
                                <option>已完结</option>
                                <option>已取消</option>
                            </select>
                        </div>
                        <button class="btn-query">查询</button>
                        <button class="btn-reset">重置</button>
                    </div>
                </div>

                <!-- 数据表格 -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="col-id">项目编号</th>
                                <th class="col-main">主项目</th>
                                <th class="col-sub">所属子项目</th>
                                <th class="col-number">项目成本(u)</th>
                                <th class="col-number">空投收益(u)</th>
                                <th class="col-number">净利润(u)</th>
                                <th class="col-number">加权平均占用</th>
                                <th class="col-days">项目天数</th>
                                <th class="col-apy">等效APY</th>
                                <th class="col-status">项目状态</th>
                                <th class="col-manager">项目负责人</th>
                                <th class="col-status">是否垫资非稳定币</th>
                                <th class="col-status">非稳定币是否归还</th>
                                <th class="col-action">操作</th>
                            </tr>
                        </thead>
                        <tbody id="fundsPoolTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <div class="pagination">
                    <div class="pagination-left">
                        <span>共 79 条</span>
                        <select>
                            <option>10条/页</option>
                            <option>20条/页</option>
                            <option>50条/页</option>
                        </select>
                    </div>
                    <div class="pagination-center">
                        <button>&lt;</button>
                        <button class="active">1</button>
                        <button>2</button>
                        <button>3</button>
                        <button>4</button>
                        <button>5</button>
                        <span>...</span>
                        <button>8</button>
                        <button>&gt;</button>
                    </div>
                    <div class="pagination-right">
                        <span>前往</span>
                        <input type="number" value="1">
                        <span>页</span>
                    </div>
                </div>
            </div>

            <!-- 项目审计页面 -->
            <div id="auditPage" class="page">
                <div class="breadcrumb">Dashboard / 对账管理 / 项目审计</div>

                <!-- 筛选工具栏 -->
                <div class="toolbar">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div class="filter-item">
                                <label>主项目</label>
                                <select style="width: 150px;">
                                    <option>全部</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label>项目负责人</label>
                                <select style="width: 150px;">
                                    <option>全部</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="refreshAuditPage()">刷新</button>
                        </div>
                    </div>
                </div>

                <!-- 数据表格 -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="col-id">项目编号</th>
                                <th class="col-main">主项目</th>
                                <th class="col-sub">所属子项目</th>
                                <th class="col-number">项目成本(u)</th>
                                <th class="col-number">空投收益(u)</th>
                                <th class="col-number">净利润(u)</th>
                                <th class="col-number">加权平均占用</th>
                                <th class="col-days">项目天数</th>
                                <th class="col-apy">等效APY <span style="font-size: 11px; color: #909399;" title="本APY基于阶段性本金释放计算，不等同于全额本金占用型项目">*</span></th>
                                <th class="col-status">项目状态</th>
                                <th class="col-manager">项目负责人</th>
                                <th class="col-status">最新审计结果</th>
                                <th class="col-status">审计次数</th>
                                <th class="col-action">操作</th>
                            </tr>
                        </thead>
                        <tbody id="auditTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- 分页 -->
                <div class="pagination">
                    <span>共 <strong id="auditTotalCount">0</strong> 条记录</span>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-sm">上一页</button>
                        <span>第 1 页，共 1 页</span>
                        <button class="btn btn-sm">下一页</button>
                    </div>
                </div>
            </div>

            <!-- 资金池详情页 -->
            <div id="detailPage" class="page detail-page">
                <button class="back-btn" onclick="showList()">← 返回列表</button>

                <div class="detail-header">
                    <h1>Opinion - Opinion-wave圣诞节活动</h1>
                    <div class="subtitle">项目编号：P20241225001 | 负责人：张三 | 状态：<span class="badge badge-info">进行中</span></div>
                </div>

                <div class="info-grid">
                    <div class="info-card">
                        <h3>项目基本信息</h3>
                        <div class="info-row">
                            <span class="info-label">项目编号</span>
                            <span class="info-value">P20241225001</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">主项目</span>
                            <span class="info-value">Opinion</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">子项目</span>
                            <span class="info-value">Opinion-wave圣诞节活动</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">负责人</span>
                            <span class="info-value">张三</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">项目状态</span>
                            <span class="info-value"><span class="badge badge-info">进行中</span></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">开始时间</span>
                            <span class="info-value">2024-12-25 15:37:12</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">结束时间</span>
                            <span class="info-value">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">项目天数</span>
                            <span class="info-value">45 天</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3>财务指标</h3>
                        <div class="info-row">
                            <span class="info-label">项目成本</span>
                            <span class="info-value text-red">$61,000</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">空投收益</span>
                            <span class="info-value">$0</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">净利润</span>
                            <span class="info-value text-red">$-61,000</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">加权平均占用</span>
                            <span class="info-value">$61,000</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">等效APY</span>
                            <span class="info-value text-red">-100.00%</span>
                        </div>
                    </div>

                    <div class="info-card">
                        <h3>资金统计</h3>
                        <div class="info-row">
                            <span class="info-label">稳定币垫资</span>
                            <span class="info-value">$61,000</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">稳定币还款</span>
                            <span class="info-value">$0</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">非稳定币垫资</span>
                            <span class="info-value">$0</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">非稳定币还款</span>
                            <span class="info-value">$0</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">非稳定币债务</span>
                            <span class="info-value">0 ETH</span>
                        </div>
                    </div>
                </div>

                <div class="coin-table">
                    <div class="coin-table-header">
                        <h3>币种明细</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>币种</th>
                                <th class="text-right">垫资金额(币)</th>
                                <th class="text-right">垫资金额(USD)</th>
                                <th class="text-right">还款金额(币)</th>
                                <th class="text-right">还款金额(USD)</th>
                                <th class="text-right">空投归集(币)</th>
                                <th class="text-right">空投归集(USD)</th>
                                <th class="text-right">差额(币)</th>
                                <th class="text-center">状态</th>
                            </tr>
                        </thead>
                        <tbody id="detailCoinTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="coin-table" style="margin-top: 30px;">
                    <div class="coin-table-header">
                        <h3>操作流水</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 100px;">唯一标识</th>
                                <th style="width: 150px;">申请事项</th>
                                <th style="width: 100px;">币种</th>
                                <th style="width: 120px; text-align: right;">金额</th>
                                <th style="width: 80px;">链</th>
                                <th style="width: 100px;">类型</th>
                                <th style="width: 100px; text-align: center;">状态</th>
                                <th style="width: 100px;">申请人</th>
                                <th style="width: 160px;">申请时间</th>
                                <th style="width: 100px;">审核人</th>
                                <th style="width: 160px;">审核时间</th>
                                <th style="width: 150px;">备注</th>
                            </tr>
                        </thead>
                        <tbody id="detailOperationTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：申请项目垫资 -->
    <div id="advanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>申请项目垫资</h2>
                <button class="modal-close" onclick="closeModal('advanceModal')">×</button>
            </div>
            <div class="form-group">
                <label>所属主项目 <span class="required">*</span></label>
                <select id="advanceMainProject" onchange="updateAdvanceSubProjects()">
                    <option value="">请选择主项目</option>
                    <option>Opinion</option>
                    <option>Gensyn</option>
                    <option>Aster一期</option>
                </select>
            </div>
            <div class="form-group">
                <label>所属子项目 <span class="required">*</span></label>
                <select id="advanceSubProject">
                    <option value="">请先选择主项目</option>
                </select>
            </div>
            <div class="form-group">
                <label>所需链 <span class="required">*</span></label>
                <select id="advanceChain">
                    <option value="">请选择链</option>
                    <option>BSC</option>
                    <option>ETH</option>
                    <option>Polygon</option>
                </select>
            </div>
            <div class="form-group">
                <label>所需币种 <span class="required">*</span></label>
                <select id="advanceCoin" onchange="toggleAdvanceWarning()">
                    <option value="">请选择币种</option>
                    <option>USDT (稳定币)</option>
                    <option>USDC (稳定币)</option>
                    <option>ETH (非稳定币)</option>
                    <option>BNB (非稳定币)</option>
                </select>
                <div id="advanceWarning" class="alert alert-warning" style="display: none; margin-top: 10px;">
                    <div class="alert-title">⚠️ 非稳定币垫资提醒</div>
                    <div class="alert-content">申请非稳定币垫资后，在项目还款阶段必须归还相同数量的非稳定币。例如：申请10 ETH，还款时必须归还10 ETH。</div>
                </div>
            </div>
            <div class="form-group">
                <label>所需金额 <span class="required">*</span></label>
                <input type="number" id="advanceAmount" placeholder="请输入金额" step="0.00000001">
            </div>
            <div class="form-group">
                <label>申请事项</label>
                <input type="text" id="advanceItem" placeholder="请输入申请事项">
            </div>
            <div class="form-group">
                <label>备注</label>
                <textarea id="advanceRemark" placeholder="请输入备注"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('advanceModal')">取消</button>
                <button class="btn btn-primary" onclick="submitAdvance()">确认</button>
            </div>
        </div>
    </div>

    <!-- 模态框：申请项目还款 -->
    <div id="repaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>申请项目还款</h2>
                <button class="modal-close" onclick="closeModal('repaymentModal')">×</button>
            </div>
            <div class="form-group">
                <label>归集类型 <span class="required">*</span></label>
                <div class="radio-group">
                    <div class="radio-item">
                        <input type="radio" name="repaymentType" id="repaymentType1" value="repayment" checked onchange="toggleRepaymentType()">
                        <label for="repaymentType1">项目还款</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" name="repaymentType" id="repaymentType2" value="airdrop" onchange="toggleRepaymentType()">
                        <label for="repaymentType2">空投归集</label>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label>所属主项目 <span class="required">*</span></label>
                <select id="repaymentMainProject" onchange="updateRepaymentSubProjects(); checkRepaymentDebt();">
                    <option value="">请选择主项目</option>
                    <option>Opinion</option>
                    <option>Gensyn</option>
                    <option>Aster一期</option>
                </select>
            </div>
            <div class="form-group">
                <label>所属子项目 <span class="required">*</span></label>
                <select id="repaymentSubProject" onchange="checkRepaymentDebt()">
                    <option value="">请先选择主项目</option>
                </select>
                <div id="repaymentDebtCheck" style="display: none; margin-top: 10px;"></div>
            </div>
            <div class="form-group">
                <label>所需链 <span class="required">*</span></label>
                <select id="repaymentChain">
                    <option value="">请选择链</option>
                    <option>BSC</option>
                    <option>ETH</option>
                </select>
            </div>
            <div class="form-group">
                <label id="repaymentCoinLabel">还款币种 <span class="required">*</span></label>
                <select id="repaymentCoin">
                    <option value="">请选择币种</option>
                    <option>USDT</option>
                    <option>ETH</option>
                </select>
            </div>
            <div class="form-group">
                <label id="repaymentAmountLabel">还款金额 <span class="required">*</span></label>
                <input type="number" id="repaymentAmount" placeholder="请输入金额" step="0.00000001">
            </div>
            <div id="repaymentAirdropDebtCheck" style="display: none; margin-top: 10px;"></div>
            <div class="form-group">
                <label>申请事项</label>
                <input type="text" id="repaymentItem" placeholder="请输入申请事项">
            </div>
            <div class="form-group">
                <label>备注</label>
                <textarea id="repaymentRemark" placeholder="请输入备注"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('repaymentModal')">取消</button>
                <button class="btn btn-primary" onclick="submitRepayment()">确认</button>
            </div>
        </div>
    </div>

    <!-- 模态框：垫资状态确认 -->
    <div id="advanceStatusConfirmModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>⚠️ 垫资状态提示</h2>
                <button class="modal-close" onclick="closeModal('advanceStatusConfirmModal')">×</button>
            </div>
            <div class="form-group" style="padding: 20px;">
                <div id="advanceStatusConfirmMessage" style="font-size: 15px; line-height: 1.6; color: #303133; margin-bottom: 20px;"></div>
                <div id="advanceStatusConfirmPendingRecords" style="display: none; margin-bottom: 20px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: #e6a23c;">未审核的垫资记录：</div>
                    <div id="advanceStatusConfirmPendingList" style="background: #f5f7fa; padding: 15px; border-radius: 4px; max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAdvanceStatusConfirmModal()">确认继续</button>
                <button class="btn btn-primary" id="advanceStatusConfirmVerifyBtn" onclick="handleAdvanceStatusVerify()">去核验</button>
            </div>
        </div>
    </div>

    <!-- 模态框：项目状态变更 -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>项目状态变更</h2>
                <button class="modal-close" onclick="closeModal('statusModal')">×</button>
            </div>
            <div class="form-group">
                <label>项目编号</label>
                <input type="text" id="statusProjectId" disabled style="background: #f5f7fa;">
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>主项目</label>
                    <input type="text" id="statusMainProject" disabled style="background: #f5f7fa;">
                </div>
                <div class="form-group">
                    <label>子项目</label>
                    <input type="text" id="statusSubProject" disabled style="background: #f5f7fa;">
                </div>
            </div>
            <div class="form-group">
                <label>当前状态</label>
                <input type="text" id="statusCurrentStatus" disabled style="background: #f5f7fa;">
            </div>
            <div class="form-group">
                <label>变更为状态 <span class="required">*</span></label>
                <select id="statusNewStatus" style="width: 100%;">
                    <option value="">请选择新状态</option>
                    <option value="进行中">进行中</option>
                    <option value="待审计">待审计</option>
                    <option value="已完结">已完结</option>
                    <option value="已取消">已取消</option>
                </select>
            </div>
            <div class="alert alert-info">
                <div class="alert-title">📌 状态变更说明</div>
                <div class="alert-content">
                    <div style="margin-bottom: 5px;">• 待审计：项目还款和空投收益都发放后，由项目负责人或数据部门变更</div>
                    <div style="margin-bottom: 5px;">• 已完结：数据部门完成对账后变更，并同步项目负责人</div>
                    <div>• 进行中/待审计：系统每两周通过飞书提醒一次</div>
                </div>
            </div>
            <div class="form-group">
                <label>变更备注</label>
                <textarea id="statusRemark" placeholder="请输入状态变更原因"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('statusModal')">取消</button>
                <button class="btn btn-primary" onclick="submitStatusChange()">确认变更</button>
            </div>
        </div>
    </div>

    <!-- 模态框：非稳定币详情 -->
    <div id="nonStableDetailModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>非稳定币垫资和还款情况</h2>
                <button class="modal-close" onclick="closeModal('nonStableDetailModal')">×</button>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label>项目编号</label>
                    <input type="text" id="nonStableProjectId" disabled style="background: #f5f7fa;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>主项目</label>
                        <input type="text" id="nonStableMainProject" disabled style="background: #f5f7fa;">
                    </div>
                    <div class="form-group">
                        <label>子项目</label>
                        <input type="text" id="nonStableSubProject" disabled style="background: #f5f7fa;">
                    </div>
                </div>
                <div class="form-group">
                    <label>非稳定币垫资情况</label>
                    <div id="nonStableAdvanceDetail" style="background: #f5f7fa; padding: 15px; border-radius: 4px; min-height: 60px; white-space: pre-wrap;"></div>
                </div>
                <div class="form-group">
                    <label>非稳定币还款情况</label>
                    <div id="nonStableRepaymentDetail" style="background: #f5f7fa; padding: 15px; border-radius: 4px; min-height: 60px; white-space: pre-wrap;"></div>
                </div>
                <div class="form-group">
                    <label>非稳定币债务情况</label>
                    <div id="nonStableDebtDetail" style="background: #fff3cd; padding: 15px; border-radius: 4px; min-height: 60px; white-space: pre-wrap; border: 1px solid #ffc107;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('nonStableDetailModal')">关闭</button>
            </div>
        </div>
    </div>

    <!-- 模态框：审核申请 -->
    <div id="auditModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>审核申请</h2>
                <button class="modal-close" onclick="closeModal('auditModal')">×</button>
            </div>
            <div style="padding: 20px;">
                <div class="form-group">
                    <label>唯一标识</label>
                    <input type="text" id="auditRecordId" disabled style="background: #f5f7fa;">
                </div>
                <div class="form-group">
                    <label>申请类型</label>
                    <input type="text" id="auditType" disabled style="background: #f5f7fa;">
                </div>
                <div class="form-group">
                    <label>申请事项</label>
                    <input type="text" id="auditItem" disabled style="background: #f5f7fa;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>所属主项目</label>
                        <input type="text" id="auditMainProject" disabled style="background: #f5f7fa;">
                    </div>
                    <div class="form-group">
                        <label>所属子项目</label>
                        <input type="text" id="auditSubProject" disabled style="background: #f5f7fa;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>币种</label>
                        <input type="text" id="auditCoin" disabled style="background: #f5f7fa;">
                    </div>
                    <div class="form-group">
                        <label>金额</label>
                        <input type="text" id="auditAmount" disabled style="background: #f5f7fa;">
                    </div>
                    <div class="form-group">
                        <label>链</label>
                        <input type="text" id="auditChain" disabled style="background: #f5f7fa;">
                    </div>
                </div>
                <div class="form-group">
                    <label>申请人</label>
                    <input type="text" id="auditApplicant" disabled style="background: #f5f7fa;">
                </div>
                <div class="form-group">
                    <label>申请时间</label>
                    <input type="text" id="auditApplyTime" disabled style="background: #f5f7fa;">
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <textarea id="auditRemark" disabled style="background: #f5f7fa; min-height: 60px;"></textarea>
                </div>
                <div class="form-group">
                    <label>审核结果 <span class="required">*</span></label>
                    <select id="auditResult" style="width: 100%;">
                        <option value="">请选择审核结果</option>
                        <option value="approved">通过</option>
                        <option value="rejected">拒绝</option>
                        <option value="cancelled">取消</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>审核备注</label>
                    <textarea id="auditComment" placeholder="请输入审核备注（选填）" style="min-height: 80px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('auditModal')">取消</button>
                <button class="btn btn-primary" onclick="submitAudit()">确认审核</button>
            </div>
        </div>
    </div>

    <!-- 模态框：项目审计 -->
    <div id="projectAuditModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>项目审计</h2>
                <button class="modal-close" onclick="closeModal('projectAuditModal')">×</button>
            </div>
            <div style="padding: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>项目编号</label>
                        <input type="text" id="auditProjectId" disabled style="background: #f5f7fa;">
                    </div>
                    <div class="form-group">
                        <label>项目状态</label>
                        <input type="text" id="auditProjectStatus" disabled style="background: #f5f7fa;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>主项目</label>
                        <input type="text" id="auditMainProjectName" disabled style="background: #f5f7fa;">
                    </div>
                    <div class="form-group">
                        <label>子项目</label>
                        <input type="text" id="auditSubProjectName" disabled style="background: #f5f7fa;">
                    </div>
                </div>
                
                <div class="alert alert-info" style="margin-top: 20px; margin-bottom: 20px;">
                    <div class="alert-title">📌 审计要求</div>
                    <div class="alert-content">
                        <div style="margin-bottom: 5px;">• 数据审计项目垫资、还款、空投实际到账情况</div>
                        <div style="margin-bottom: 5px;">• 检查所属交易所余额是否清空</div>
                        <div>• 检查链上钱包是否清空</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px; margin-bottom: 15px; font-size: 16px; font-weight: 600;">资金到账情况</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>项目垫资实际到账 <span class="required">*</span></label>
                        <select id="auditAdvanceReceived" style="width: 100%;">
                            <option value="">请选择</option>
                            <option value="yes">已全部到账</option>
                            <option value="partial">部分到账</option>
                            <option value="no">未到账</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>项目还款实际到账 <span class="required">*</span></label>
                        <select id="auditRepaymentReceived" style="width: 100%;">
                            <option value="">请选择</option>
                            <option value="yes">已全部到账</option>
                            <option value="partial">部分到账</option>
                            <option value="no">未到账</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>空投收益实际到账 <span class="required">*</span></label>
                        <select id="auditAirdropReceived" style="width: 100%;">
                            <option value="">请选择</option>
                            <option value="yes">已全部到账</option>
                            <option value="partial">部分到账</option>
                            <option value="no">未到账</option>
                        </select>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px; margin-bottom: 15px; font-size: 16px; font-weight: 600;">账户清空情况</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label>所属交易所余额 <span class="required">*</span></label>
                        <select id="auditExchangeCleared" style="width: 100%;">
                            <option value="">请选择</option>
                            <option value="yes">已清空</option>
                            <option value="no">未清空</option>
                            <option value="na">不适用</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>链上钱包余额 <span class="required">*</span></label>
                        <select id="auditWalletCleared" style="width: 100%;">
                            <option value="">请选择</option>
                            <option value="yes">已清空</option>
                            <option value="no">未清空</option>
                            <option value="na">不适用</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>审计结果 <span class="required">*</span></label>
                    <select id="auditResultStatus" style="width: 100%;">
                        <option value="">请选择审计结果</option>
                        <option value="passed">通过</option>
                        <option value="failed">不通过</option>
                        <option value="pending">待补充材料</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>审计备注</label>
                    <textarea id="auditCommentText" placeholder="请输入审计备注，如有问题请详细说明" style="min-height: 100px;"></textarea>
                </div>
                
                <h3 style="margin-top: 20px; margin-bottom: 15px; font-size: 16px; font-weight: 600;">项目申请记录</h3>
                <div style="margin-bottom: 20px;">
                    <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                        <table style="font-size: 13px;">
                            <thead style="position: sticky; top: 0; background: white; z-index: 10;">
                                <tr>
                                    <th style="width: 80px;">唯一标识</th>
                                    <th style="width: 120px;">申请事项</th>
                                    <th style="width: 100px;">所属子项目</th>
                                    <th style="width: 80px;">币种</th>
                                    <th style="width: 100px; text-align: right;">金额</th>
                                    <th style="width: 80px;">链</th>
                                    <th style="width: 100px;">类型</th>
                                    <th style="width: 100px; text-align: center;">状态</th>
                                    <th style="width: 100px;">申请人</th>
                                    <th style="width: 150px;">申请时间</th>
                                </tr>
                            </thead>
                            <tbody id="auditRecordsTableBody">
                                <tr><td colspan="10" style="text-align: center; padding: 20px; color: #909399;">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px; margin-bottom: 15px; font-size: 16px; font-weight: 600;">资金统计（按币种）</h3>
                <div style="margin-bottom: 20px;">
                    <div class="table-container">
                        <table style="font-size: 13px;">
                            <thead>
                                <tr>
                                    <th style="width: 100px;">币种</th>
                                    <th style="width: 150px; text-align: right;">垫资金额</th>
                                    <th style="width: 150px; text-align: right;">还款金额</th>
                                    <th style="width: 150px; text-align: right;">空投收益</th>
                                    <th style="width: 150px; text-align: right;">差额</th>
                                </tr>
                            </thead>
                            <tbody id="auditCoinStatsTableBody">
                                <tr><td colspan="5" style="text-align: center; padding: 20px; color: #909399;">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #f5f7fa; border-radius: 4px;">
                    <div style="font-weight: 600; margin-bottom: 10px;">审计历史记录</div>
                    <div id="auditHistoryList" style="max-height: 200px; overflow-y: auto;">
                        <div style="color: #909399; text-align: center; padding: 20px;">暂无审计记录</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('projectAuditModal')">取消</button>
                <button class="btn btn-primary" onclick="submitProjectAudit()">提交审计</button>
            </div>
        </div>
    </div>

    <!-- 模态框：创建新项目 -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>创建新项目</h2>
                <button class="modal-close" onclick="closeModal('createModal')">×</button>
            </div>
            <div class="alert alert-info" style="margin-bottom: 20px;">
                <div class="alert-title">📌 项目分组规则</div>
                <div class="alert-content">
                    <div style="margin-bottom: 5px;">• 如果多个项目的空投会一起发放（无法拆分到具体子项目），这些项目归属于同一个主项目</div>
                    <div style="margin-bottom: 5px;">• 如果项目单独发放空投，需要单独创建主项目，例如：Aster一期、Aster二期</div>
                    <div>• 空投收益将以主项目为维度进行计算</div>
                </div>
            </div>
            <div class="form-group">
                <label>主项目名称 <span class="required">*</span></label>
                <input type="text" id="createMainProject" placeholder="请输入主项目名称，例如：Opinion、Aster一期">
            </div>
            <div class="form-group">
                <label>子项目名称 <span class="required">*</span></label>
                <input type="text" id="createSubProject" placeholder="请输入子项目名称">
            </div>
            <div class="form-group">
                <label>项目负责人 <span class="required">*</span></label>
                <select id="createManager">
                    <option value="">请选择负责人</option>
                    <option>张三</option>
                    <option>李四</option>
                    <option>王五</option>
                </select>
            </div>
            <div class="form-group">
                <label>备注</label>
                <textarea id="createRemark" placeholder="请输入项目备注信息"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createModal')">取消</button>
                <button class="btn btn-primary" onclick="submitCreateProject()">确认创建</button>
            </div>
        </div>
    </div>

    <script>
        // 页面切换
        function showPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示目标页面
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // 更新导航栏active状态
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            sidebarItems.forEach(item => {
                // 重置所有子项的样式
                if (item.style.paddingLeft === '40px') {
                    item.style.background = '';
                }
            });
            
            // 设置当前页面对应的导航项为active
            if (pageId === 'advanceFundingPage') {
                // 对账管理父项
                sidebarItems[8].classList.add('active');
                // 项目垫资子项
                sidebarItems[9].style.background = '#409eff';
                sidebarItems[10].style.background = ''; // 清除资金池的高亮
            } else if (pageId === 'fundsPoolPage') {
                // 对账管理父项
                sidebarItems[8].classList.add('active');
                // 资金池子项
                sidebarItems[10].style.background = '#409eff';
                sidebarItems[9].style.background = ''; // 清除项目垫资的高亮
                sidebarItems[11].style.background = ''; // 清除待审计的高亮
                // 切换到资金池页面时，更新数据
                setTimeout(function() {
                    updateFundsPoolFromAdvanceRecords();
                }, 100);
            } else if (pageId === 'auditPage') {
                // 对账管理父项
                sidebarItems[8].classList.add('active');
                // 待审计子项
                sidebarItems[11].style.background = '#409eff';
                sidebarItems[9].style.background = ''; // 清除项目垫资的高亮
                sidebarItems[10].style.background = ''; // 清除资金池的高亮
                // 切换到项目审计页面时，更新数据
                setTimeout(function() {
                    console.log('切换到项目审计页面，开始更新数据');
                    refreshAuditPage();
                }, 200);
            }
        }

        // 确保showDetail在全局作用域
        window.showDetail = function(projectId, mainProject, subProject) {
            console.log('showDetail called:', projectId, mainProject, subProject);
            
            // 存储当前查看的项目信息
            if (projectId && mainProject && subProject) {
                window.currentDetailProject = { projectId, mainProject, subProject };
            } else if (window.currentDetailProject) {
                // 如果已有存储的项目信息，使用它
                projectId = window.currentDetailProject.projectId;
                mainProject = window.currentDetailProject.mainProject;
                subProject = window.currentDetailProject.subProject;
            } else {
                // 如果没有传递参数，使用默认值（兼容旧代码）
                projectId = projectId || 'P20241225001';
                mainProject = mainProject || 'Opinion';
                subProject = subProject || 'Opinion-wave圣诞节活动';
            }
            
            // 填充详情页数据
            if (typeof fillProjectDetail === 'function') {
                fillProjectDetail(projectId, mainProject, subProject);
            } else {
                console.error('fillProjectDetail函数未找到');
            }
            
            const fundsPoolPage = document.getElementById('fundsPoolPage');
            const detailPage = document.getElementById('detailPage');
            
            if (fundsPoolPage && detailPage) {
                fundsPoolPage.classList.remove('active');
                detailPage.classList.add('active');
                console.log('页面切换成功');
            } else {
                console.error('页面元素未找到:', { fundsPoolPage, detailPage });
            }
        };
        
        // 同时保留原函数名以兼容
        function showDetail(projectId, mainProject, subProject) {
            return window.showDetail(projectId, mainProject, subProject);
        }

        // 填充项目详情页数据
        function fillProjectDetail(projectId, mainProject, subProject) {
            // 从项目垫资表中获取该项目的所有记录
            const advanceTbody = document.getElementById('advanceFundingTableBody');
            if (!advanceTbody) return;
            
            // 存储统计数据
            const stats = {
                advanceAmount: 0,
                repaymentAmount: 0,
                airdropAmount: 0,
                startTime: null,
                manager: '',
                coinStats: {} // {币种: {垫资: 数量, 还款: 数量, 空投: 数量}}
            };
            
            // 存储操作流水
            const operationRecords = [];
            
            // 遍历项目垫资表的所有记录
            const advanceRows = advanceTbody.querySelectorAll('tr');
            advanceRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 15) return;
                
                const rowMainProject = cells[2]?.textContent.trim();
                const rowSubProject = cells[3]?.textContent.trim();
                
                // 只处理匹配的项目
                if (rowMainProject !== mainProject || rowSubProject !== subProject) return;
                
                const recordId = cells[0]?.textContent.trim();
                const item = cells[1]?.textContent.trim();
                const coin = cells[4]?.textContent.trim();
                const amountText = cells[5]?.textContent.trim().replace(/,/g, '');
                const chain = cells[6]?.textContent.trim();
                const type = cells[7]?.textContent.trim();
                const statusBadge = cells[8]?.querySelector('.badge');
                const status = statusBadge ? statusBadge.textContent.trim() : '';
                const applicant = cells[9]?.textContent.trim();
                const applyTime = cells[10]?.textContent.trim();
                const approver = cells[11]?.textContent.trim();
                const approveTime = cells[12]?.textContent.trim();
                const remark = cells[13]?.textContent.trim();
                
                const amount = parseFloat(amountText) || 0;
                
                // 记录操作流水（所有记录，不限于已审核）
                operationRecords.push({
                    recordId, item, coin, amount, chain, type, status, applicant, applyTime, approver, approveTime, remark
                });
                
                // 只统计已审核的记录
                if (status !== '已审核') return;
                
                // 更新项目负责人
                if (!stats.manager && applicant) {
                    stats.manager = applicant;
                }
                
                // 更新开始时间
                if (applyTime && (!stats.startTime || applyTime < stats.startTime)) {
                    stats.startTime = applyTime;
                }
                
                const coinUpper = coin.toUpperCase();
                const isNonStable = nonStableCoins.includes(coinUpper);
                
                // 按类型累加（区分稳定币和非稳定币）
                if (type === '项目垫资') {
                    if (!isNonStable) {
                        // 只统计稳定币垫资
                        stats.advanceAmount += amount;
                    }
                } else if (type === '项目还款') {
                    if (!isNonStable) {
                        // 只统计稳定币还款
                        stats.repaymentAmount += amount;
                    }
                } else if (type === '空投归集') {
                    stats.airdropAmount += amount;
                }
                
                // 按币种统计（所有币种都统计）
                if (!stats.coinStats[coin]) {
                    stats.coinStats[coin] = { advance: 0, repayment: 0, airdrop: 0 };
                }
                if (type === '项目垫资') {
                    stats.coinStats[coin].advance += amount;
                } else if (type === '项目还款') {
                    stats.coinStats[coin].repayment += amount;
                } else if (type === '空投归集') {
                    stats.coinStats[coin].airdrop += amount;
                }
            });
            
            // 计算统计数据
            const projectCost = stats.advanceAmount - stats.repaymentAmount;
            const netProfit = stats.airdropAmount - projectCost;
            
            // 计算项目天数
            let projectDays = 45;
            const now = new Date();
            let startDate = null;
            if (stats.startTime) {
                startDate = new Date(stats.startTime);
                const diffTime = Math.abs(now - startDate);
                projectDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }
            
            // 计算加权平均占用资金（基于每日资金余额）
            // 公式：加权平均占用 = sum(每日资金余额 × 持续天数) / 项目总天数
            let weightedAvgOccupancy = 0;
            if (startDate && projectDays > 0) {
                const advanceTbody = document.getElementById('advanceFundingTableBody');
                if (advanceTbody) {
                    // 收集所有已审核的稳定币垫资和还款记录，按时间排序
                    const transactions = [];
                    const advanceRows = advanceTbody.querySelectorAll('tr');
                    advanceRows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length < 15) return;
                        
                        const rowMainProject = cells[2]?.textContent.trim();
                        const rowSubProject = cells[3]?.textContent.trim();
                        if (rowMainProject !== stats.mainProject || rowSubProject !== stats.subProject) return;
                        
                        const rowCoin = cells[4]?.textContent.trim();
                        const rowAmountText = cells[5]?.textContent.trim().replace(/,/g, '');
                        const rowType = cells[7]?.textContent.trim();
                        const rowStatusBadge = cells[8]?.querySelector('.badge');
                        const rowStatus = rowStatusBadge ? rowStatusBadge.textContent.trim() : '';
                        const rowApplyTime = cells[10]?.textContent.trim();
                        
                        // 只统计已审核的稳定币记录
                        if (rowStatus !== '已审核') return;
                        const rowCoinUpper = rowCoin.toUpperCase();
                        if (nonStableCoins.includes(rowCoinUpper)) return; // 跳过非稳定币
                        
                        const rowAmount = parseFloat(rowAmountText) || 0;
                        if (rowAmount <= 0 || !rowApplyTime) return;
                        
                        // 确定交易类型和金额变化
                        let amountChange = 0;
                        if (rowType === '项目垫资') {
                            amountChange = rowAmount; // 垫资增加余额
                        } else if (rowType === '项目还款') {
                            amountChange = -rowAmount; // 还款减少余额
                        } else {
                            return; // 空投归集不影响资金占用余额
                        }
                        
                        transactions.push({
                            time: new Date(rowApplyTime),
                            amountChange: amountChange
                        });
                    });
                    
                    // 按时间排序
                    transactions.sort((a, b) => a.time - b.time);
                    
                    // 计算每日资金余额的加权和
                    let totalWeightedBalance = 0; // sum(每日资金余额 × 持续天数)
                    let currentBalance = 0; // 当前资金余额
                    let prevDate = startDate;
                    
                    // 遍历所有交易，计算每个时间段的余额和持续天数
                    for (let i = 0; i <= transactions.length; i++) {
                        let nextDate = now;
                        if (i < transactions.length) {
                            nextDate = transactions[i].time;
                        }
                        
                        // 计算这个时间段的持续天数
                        const daysInPeriod = Math.ceil(Math.abs(nextDate - prevDate) / (1000 * 60 * 60 * 24));
                        if (daysInPeriod > 0 && currentBalance > 0) {
                            // 累加：余额 × 持续天数
                            totalWeightedBalance += currentBalance * daysInPeriod;
                        }
                        
                        // 如果有交易，更新余额
                        if (i < transactions.length) {
                            currentBalance += transactions[i].amountChange;
                            if (currentBalance < 0) currentBalance = 0; // 余额不能为负
                            prevDate = nextDate;
                        } else {
                            prevDate = nextDate;
                        }
                    }
                    
                    // 加权平均占用 = sum(每日资金余额 × 持续天数) / 项目总天数
                    weightedAvgOccupancy = totalWeightedBalance / projectDays;
                }
            }
            
            // 如果加权平均占用为0，使用垫资金额作为后备
            if (weightedAvgOccupancy <= 0) {
                weightedAvgOccupancy = stats.advanceAmount;
            }
            
            // 计算等效APY（资金效率视角）
            // 公式：等效APY = (净利润 / 加权平均占用) × (365 / 项目天数) × 100%
            // 其中：加权平均占用 = sum(每日资金余额 × 持续天数) / 项目总天数
            let equivalentAPY = 0;
            if (weightedAvgOccupancy > 0 && projectDays > 0) {
                equivalentAPY = (netProfit / weightedAvgOccupancy) * (365 / projectDays) * 100;
            }
            
            // 格式化函数
            const formatAmount = (num) => {
                if (num === 0) return '$0';
                const sign = num >= 0 ? '' : '-';
                const absNum = Math.abs(num);
                return `${sign}$${absNum.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
            };
            
            const formatAPY = (apy) => {
                const sign = apy >= 0 ? '' : '-';
                const absApy = Math.abs(apy);
                return `${sign}${absApy.toFixed(2)}%`;
            };
            
            // 确定项目状态
            let statusText = '进行中';
            let statusBadgeHtml = '<span class="badge badge-info">进行中</span>';
            if (projectCost <= 0 && stats.airdropAmount > 0) {
                statusText = '待审计';
                statusBadgeHtml = '<span class="badge badge-warning">待审计</span>';
            }
            
            // 更新详情页头部
            const detailHeader = document.querySelector('#detailPage .detail-header h1');
            if (detailHeader) {
                detailHeader.textContent = `${mainProject} - ${subProject}`;
            }
            const detailSubtitle = document.querySelector('#detailPage .detail-header .subtitle');
            if (detailSubtitle) {
                detailSubtitle.innerHTML = `项目编号：${projectId} | 负责人：${stats.manager || '未知'} | 状态：${statusBadgeHtml}`;
            }
            
            // 更新基本信息
            const firstInfoCard = document.querySelector('#detailPage .info-card');
            if (firstInfoCard) {
                const infoRows = firstInfoCard.querySelectorAll('.info-row');
                if (infoRows.length > 0 && infoRows[0].querySelector('.info-value')) {
                    infoRows[0].querySelector('.info-value').textContent = projectId;
                }
                if (infoRows.length > 1 && infoRows[1].querySelector('.info-value')) {
                    infoRows[1].querySelector('.info-value').textContent = mainProject;
                }
                if (infoRows.length > 2 && infoRows[2].querySelector('.info-value')) {
                    infoRows[2].querySelector('.info-value').textContent = subProject;
                }
                if (infoRows.length > 3 && infoRows[3].querySelector('.info-value')) {
                    infoRows[3].querySelector('.info-value').textContent = stats.manager || '未知';
                }
                if (infoRows.length > 4 && infoRows[4].querySelector('.info-value')) {
                    infoRows[4].querySelector('.info-value').innerHTML = statusBadgeHtml;
                }
                if (infoRows.length > 5 && infoRows[5].querySelector('.info-value')) {
                    infoRows[5].querySelector('.info-value').textContent = stats.startTime ? stats.startTime.replace('T', ' ') : '-';
                }
                if (infoRows.length > 6 && infoRows[6].querySelector('.info-value')) {
                    infoRows[6].querySelector('.info-value').textContent = '-';
                }
                if (infoRows.length > 7 && infoRows[7].querySelector('.info-value')) {
                    infoRows[7].querySelector('.info-value').textContent = `${projectDays} 天`;
                }
            }
            
            // 更新财务指标
            const infoCards = document.querySelectorAll('#detailPage .info-card');
            if (infoCards.length > 1) {
                const financeCard = infoCards[1];
                const financeRows = financeCard.querySelectorAll('.info-row');
                if (financeRows.length > 0 && financeRows[0].querySelector('.info-value')) {
                    financeRows[0].querySelector('.info-value').innerHTML = `<span class="${projectCost > 0 ? 'text-red' : ''}">${formatAmount(projectCost)}</span>`;
                }
                if (financeRows.length > 1 && financeRows[1].querySelector('.info-value')) {
                    financeRows[1].querySelector('.info-value').textContent = formatAmount(stats.airdropAmount);
                }
                if (financeRows.length > 2 && financeRows[2].querySelector('.info-value')) {
                    financeRows[2].querySelector('.info-value').innerHTML = `<span class="${netProfit >= 0 ? 'text-green' : 'text-red'}">${formatAmount(netProfit)}</span>`;
                }
                if (financeRows.length > 3 && financeRows[3].querySelector('.info-value')) {
                    financeRows[3].querySelector('.info-value').textContent = formatAmount(weightedAvgOccupancy);
                }
                if (financeRows.length > 4 && financeRows[4].querySelector('.info-value')) {
                    // 显示等效APY，并添加备注说明
                    const apyValue = formatAPY(equivalentAPY);
                    const apyColor = equivalentAPY >= 0 ? 'text-green' : 'text-red';
                    financeRows[4].querySelector('.info-value').innerHTML = `
                        <span class="${apyColor}">${apyValue}</span>
                        <span style="font-size: 11px; color: #909399; margin-left: 5px;" title="本APY基于阶段性本金释放计算，不等同于全额本金占用型项目">*</span>
                    `;
                }
            }
            
            // 更新资金统计
            if (infoCards.length > 2) {
                const fundCard = infoCards[2];
                const fundRows = fundCard.querySelectorAll('.info-row');
                // 稳定币垫资
                if (fundRows.length > 0 && fundRows[0].querySelector('.info-value')) {
                    fundRows[0].querySelector('.info-value').textContent = formatAmount(stats.advanceAmount);
                }
                // 稳定币还款
                if (fundRows.length > 1 && fundRows[1].querySelector('.info-value')) {
                    fundRows[1].querySelector('.info-value').textContent = formatAmount(stats.repaymentAmount);
                }
                // 非稳定币垫资
                if (fundRows.length > 2 && fundRows[2].querySelector('.info-value')) {
                    const nonStableAdvanceList = Object.keys(stats.coinStats).filter(coin => {
                        return nonStableCoins.includes(coin.toUpperCase()) && stats.coinStats[coin].advance > 0;
                    }).map(coin => {
                        const amount = stats.coinStats[coin].advance;
                        return `${coin.toLowerCase()}:${formatNumber(amount)}`;
                    }).join(',');
                    fundRows[2].querySelector('.info-value').textContent = nonStableAdvanceList || '0';
                }
                // 非稳定币还款
                if (fundRows.length > 3 && fundRows[3].querySelector('.info-value')) {
                    const nonStableRepaymentList = Object.keys(stats.coinStats).filter(coin => {
                        return nonStableCoins.includes(coin.toUpperCase()) && stats.coinStats[coin].repayment > 0;
                    }).map(coin => {
                        const amount = stats.coinStats[coin].repayment;
                        return `${coin.toLowerCase()}:${formatNumber(amount)}`;
                    }).join(',');
                    fundRows[3].querySelector('.info-value').textContent = nonStableRepaymentList || '0';
                }
                // 非稳定币债务
                if (fundRows.length > 4 && fundRows[4].querySelector('.info-value')) {
                    const nonStableDebtList = Object.keys(stats.coinStats).filter(coin => {
                        if (!nonStableCoins.includes(coin.toUpperCase())) return false;
                        const diff = stats.coinStats[coin].advance - stats.coinStats[coin].repayment;
                        return diff > 0.0001; // 允许小的误差
                    }).map(coin => {
                        const diff = stats.coinStats[coin].advance - stats.coinStats[coin].repayment;
                        return `${coin.toLowerCase()}:${formatNumber(diff)}`;
                    }).join(',');
                    fundRows[4].querySelector('.info-value').textContent = nonStableDebtList || '0';
                }
            }
            
            // 更新币种明细表格
            const coinTableBody = document.getElementById('detailCoinTableBody');
            coinTableBody.innerHTML = '';
            Object.keys(stats.coinStats).forEach(coin => {
                const coinStat = stats.coinStats[coin];
                const diff = coinStat.advance - coinStat.repayment;
                const isNonStable = nonStableCoins.includes(coin.toUpperCase());
                const row = document.createElement('tr');
                
                // 非稳定币不显示USD金额
                const advanceUsdCell = isNonStable ? '<td class="text-right">-</td>' : `<td class="text-right">${formatAmount(coinStat.advance)}</td>`;
                const repaymentUsdCell = isNonStable ? '<td class="text-right">-</td>' : `<td class="text-right">${formatAmount(coinStat.repayment)}</td>`;
                const airdropUsdCell = isNonStable ? '<td class="text-right">-</td>' : `<td class="text-right">${formatAmount(coinStat.airdrop)}</td>`;
                
                row.innerHTML = `
                    <td><strong>${coin.toUpperCase()}</strong></td>
                    <td class="text-right">${formatNumber(coinStat.advance)}</td>
                    ${advanceUsdCell}
                    <td class="text-right">${formatNumber(coinStat.repayment)}</td>
                    ${repaymentUsdCell}
                    <td class="text-right">${formatNumber(coinStat.airdrop)}</td>
                    ${airdropUsdCell}
                    <td class="text-right ${diff > 0 ? 'text-red' : ''}">${formatNumber(diff)}</td>
                    <td class="text-center"><span class="badge badge-normal">${diff === 0 ? '正常' : '有差额'}</span></td>
                `;
                coinTableBody.appendChild(row);
            });
            
            // 更新操作流水表格
            const operationTableBody = document.getElementById('detailOperationTableBody');
            if (!operationTableBody) {
                console.error('detailOperationTableBody元素未找到');
                return;
            }
            operationTableBody.innerHTML = '';
            
            // 按申请时间倒序排列
            operationRecords.sort((a, b) => {
                if (b.applyTime && a.applyTime) {
                    return b.applyTime.localeCompare(a.applyTime);
                }
                return 0;
            });
            
            operationRecords.forEach(record => {
                const row = document.createElement('tr');
                
                // 状态徽章
                let statusBadge = '';
                if (record.status === '已审核') {
                    statusBadge = '<span class="badge badge-success">已审核</span>';
                } else if (record.status === '待审核') {
                    statusBadge = '<span class="badge" style="background: #e6a23c; color: white;">待审核</span>';
                } else if (record.status === '已拒绝') {
                    statusBadge = '<span class="badge" style="background: #f56c6c; color: white;">已拒绝</span>';
                } else if (record.status === '已取消') {
                    statusBadge = '<span class="badge" style="background: #909399; color: white;">已取消</span>';
                } else {
                    statusBadge = `<span class="badge">${record.status || '-'}</span>`;
                }
                
                row.innerHTML = `
                    <td>${record.recordId}</td>
                    <td>${record.item || '-'}</td>
                    <td>${record.coin.toLowerCase()}</td>
                    <td class="text-right">${record.amount.toLocaleString()}</td>
                    <td>${record.chain.toLowerCase()}</td>
                    <td>${record.type}</td>
                    <td class="text-center">${statusBadge}</td>
                    <td>${record.applicant || '-'}</td>
                    <td>${record.applyTime ? record.applyTime.replace('T', ' ') : '-'}</td>
                    <td>${record.approver || '-'}</td>
                    <td>${record.approveTime ? record.approveTime.replace('T', ' ') : '-'}</td>
                    <td>${record.remark || '-'}</td>
                `;
                operationTableBody.appendChild(row);
            });
        }

        function showList() {
            document.getElementById('detailPage').classList.remove('active');
            document.getElementById('fundsPoolPage').classList.add('active');
        }

        // 打开非稳定币详情模态框（确保在全局作用域）
        window.openNonStableDetailModal = function(projectId, mainProject, subProject, nonStableAdvance, nonStableRepayment) {
            // 添加null检查
            const projectIdEl = document.getElementById('nonStableProjectId');
            const mainProjectEl = document.getElementById('nonStableMainProject');
            const subProjectEl = document.getElementById('nonStableSubProject');
            const advanceDetailEl = document.getElementById('nonStableAdvanceDetail');
            const repaymentDetailEl = document.getElementById('nonStableRepaymentDetail');
            const debtDetailEl = document.getElementById('nonStableDebtDetail');
            
            if (!projectIdEl || !mainProjectEl || !subProjectEl || !advanceDetailEl || !repaymentDetailEl || !debtDetailEl) {
                console.error('非稳定币详情模态框元素未找到');
                alert('模态框元素未找到，请刷新页面重试');
                return;
            }
            
            projectIdEl.value = projectId || '';
            mainProjectEl.value = mainProject || '';
            subProjectEl.value = subProject || '';
            
            // 格式化非稳定币垫资情况
            let advanceText = '';
            if (nonStableAdvance && Object.keys(nonStableAdvance).length > 0) {
                advanceText = Object.keys(nonStableAdvance).map(coin => {
                    const amount = nonStableAdvance[coin];
                    return `${coin.toUpperCase()}: ${formatNumber(amount)}`;
                }).join('\n');
            } else {
                advanceText = '无';
            }
            advanceDetailEl.textContent = advanceText;
            
            // 格式化非稳定币还款情况
            let repaymentText = '';
            if (nonStableRepayment && Object.keys(nonStableRepayment).length > 0) {
                repaymentText = Object.keys(nonStableRepayment).map(coin => {
                    const amount = nonStableRepayment[coin];
                    return `${coin.toUpperCase()}: ${formatNumber(amount)}`;
                }).join('\n');
            } else {
                repaymentText = '无';
            }
            repaymentDetailEl.textContent = repaymentText;
            
            // 计算并显示债务情况
            let debtText = '';
            const debts = {};
            Object.keys(nonStableAdvance || {}).forEach(coin => {
                const advance = nonStableAdvance[coin] || 0;
                const repayment = (nonStableRepayment && nonStableRepayment[coin]) || 0;
                const diff = advance - repayment;
                if (diff > 0.0001) { // 允许小的误差
                    debts[coin] = diff;
                }
            });
            
            if (Object.keys(debts).length > 0) {
                debtText = Object.keys(debts).map(coin => {
                    return `${coin.toUpperCase()}: 欠款 ${formatNumber(debts[coin])} ${coin.toUpperCase()}`;
                }).join('\n');
            } else {
                debtText = '无债务（已全部归还）';
            }
            debtDetailEl.textContent = debtText;
            
            openModal('nonStableDetailModal');
        };
        
        // 同时保留原函数名以兼容
        function openNonStableDetailModal(projectId, mainProject, subProject, nonStableAdvance, nonStableRepayment) {
            return window.openNonStableDetailModal(projectId, mainProject, subProject, nonStableAdvance, nonStableRepayment);
        }

        // 数据存储
        let projectsList = [];
        let recordIdCounter = 1000;
        let projectIdCounter = 20241225001; // 项目编号计数器

        // 存储项目负责人信息（主项目+子项目 -> 负责人）
        const projectManagers = {};
        
        // 存储项目审计记录 {主项目-子项目: [{审计记录}]}
        const projectAuditRecords = {};
        
        // 存储项目状态 {主项目-子项目: 状态}
        const projectStatuses = {};

        // 项目与子项目的映射
        const projectMapping = {
            'Opinion': ['Opinion-wave圣诞节活动'],
            'Gensyn': ['gensyn_bid'],
            'Aster一期': ['Aster一期-打新'],
            '测试主项目': ['测试子项目']
        };

        // 非稳定币列表
        const nonStableCoins = ['ETH', 'BNB', 'BTC', 'SOL', 'eth', 'bnb', 'btc', 'sol'];

        // 计算项目的非稳定币债务
        function calculateNonStableCoinDebt(mainProject, subProject) {
            const tbody = document.getElementById('advanceFundingTableBody');
            if (!tbody) return {};
            
            const debts = {}; // {币种: {垫资: 数量, 还款: 数量, 差额: 数量}}
            
            // 遍历表格中所有行
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 8) return;
                
                const rowMainProject = cells[2]?.textContent.trim();
                const rowSubProject = cells[3]?.textContent.trim();
                const coin = cells[4]?.textContent.trim().toUpperCase();
                const amount = parseFloat(cells[5]?.textContent.trim().replace(/,/g, '') || 0);
                const type = cells[7]?.textContent.trim();
                const statusBadge = cells[8]?.querySelector('.badge');
                const status = statusBadge ? statusBadge.textContent.trim() : '';
                
                // 只计算已审核的记录，且匹配当前项目
                // 确保项目匹配，并且记录是已审核状态
                if (rowMainProject === mainProject && rowSubProject === subProject && status === '已审核') {
                    // 检查是否为非稳定币
                    if (nonStableCoins.includes(coin)) {
                        if (!debts[coin]) {
                            debts[coin] = { advance: 0, repayment: 0, diff: 0 };
                        }
                        
                        if (type === '项目垫资') {
                            debts[coin].advance += amount;
                        } else if (type === '项目还款') {
                            debts[coin].repayment += amount;
                        }
                        
                        debts[coin].diff = debts[coin].advance - debts[coin].repayment;
                    }
                }
            });
            
            // 返回有债务的币种
            const result = {};
            Object.keys(debts).forEach(coin => {
                if (debts[coin].diff > 0.0001) { // 允许小的误差
                    result[coin] = debts[coin];
                }
            });
            
            return result;
        }

        // 获取债务描述文本
        function getDebtDescription(debts, mainProject, subProject) {
            const descriptions = [];
            Object.keys(debts).forEach(coin => {
                const debt = debts[coin];
                // 格式化数字，自动去掉末尾的0
                const diffFormatted = formatNumber(debt.diff);
                const advanceFormatted = formatNumber(debt.advance);
                const repaymentFormatted = formatNumber(debt.repayment);
                descriptions.push(`${coin}: 欠款 ${diffFormatted} ${coin}（垫资 ${advanceFormatted}，已还款 ${repaymentFormatted}）`);
            });
            return descriptions.join('；');
        }

        // 更新主项目下拉框选项（从projectMapping动态加载）
        function updateMainProjectOptions(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentValue = select.value;
            // 保留第一个"请选择"选项
            const firstOption = select.querySelector('option[value=""]');
            select.innerHTML = '';
            if (firstOption) {
                select.appendChild(firstOption);
            } else {
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = '请选择主项目';
                select.appendChild(placeholderOption);
            }
            
            // 添加所有项目
            Object.keys(projectMapping).sort().forEach(mainProj => {
                const option = document.createElement('option');
                option.value = mainProj;
                option.textContent = mainProj;
                select.appendChild(option);
            });
            
            // 恢复之前的值
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function openModal(modalId, mainProject, subProject) {
            // 先关闭所有其他模态框
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            
            // 打开目标模态框
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error('Modal not found:', modalId);
                return;
            }
            modal.classList.add('active');
            
            // 更新主项目下拉框选项
            if (modalId === 'advanceModal') {
                updateMainProjectOptions('advanceMainProject');
            } else if (modalId === 'repaymentModal') {
                updateMainProjectOptions('repaymentMainProject');
            }
            
            // 如果传入了项目信息，自动填充
            if (mainProject && modalId === 'repaymentModal') {
                const mainProjectSelect = document.getElementById('repaymentMainProject');
                if (mainProjectSelect) {
                    mainProjectSelect.value = mainProject;
                    updateRepaymentSubProjects();
                    // 确保默认选择"项目还款"类型
                    const repaymentType1 = document.querySelector('#repaymentType1');
                    if (repaymentType1) {
                        repaymentType1.checked = true;
                    }
                    // 确保提交按钮是启用状态
                    const submitBtn = document.querySelector('#repaymentModal .btn-primary');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                    }
                    toggleRepaymentType();
                    if (subProject) {
                        setTimeout(() => {
                            const subProjectSelect = document.getElementById('repaymentSubProject');
                            if (subProjectSelect) {
                                subProjectSelect.value = subProject;
                                setTimeout(() => {
                                    checkRepaymentDebt();
                                }, 50);
                            }
                        }, 100);
                    }
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // 打开审核模态框
        function openAuditModal(recordId) {
            const tbody = document.getElementById('advanceFundingTableBody');
            if (!tbody) return;
            
            // 查找对应的行
            const rows = tbody.querySelectorAll('tr');
            let targetRow = null;
            for (let row of rows) {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0 && cells[0].textContent.trim() === recordId) {
                    targetRow = row;
                    break;
                }
            }
            
            if (!targetRow) {
                alert('未找到该记录');
                return;
            }
            
            const cells = targetRow.querySelectorAll('td');
            if (cells.length < 15) {
                alert('记录数据不完整');
                return;
            }
            
            // 填充审核模态框数据
            document.getElementById('auditRecordId').value = cells[0].textContent.trim();
            document.getElementById('auditType').value = cells[7].textContent.trim();
            document.getElementById('auditItem').value = cells[1].textContent.trim();
            document.getElementById('auditMainProject').value = cells[2].textContent.trim();
            document.getElementById('auditSubProject').value = cells[3].textContent.trim();
            document.getElementById('auditCoin').value = cells[4].textContent.trim();
            document.getElementById('auditAmount').value = cells[5].textContent.trim();
            document.getElementById('auditChain').value = cells[6].textContent.trim();
            document.getElementById('auditApplicant').value = cells[9].textContent.trim();
            document.getElementById('auditApplyTime').value = cells[10].textContent.trim();
            document.getElementById('auditRemark').value = cells[13].textContent.trim() || '';
            
            // 清空审核结果和备注
            document.getElementById('auditResult').value = '';
            document.getElementById('auditComment').value = '';
            
            // 存储当前审核的行，以便后续更新
            document.getElementById('auditModal').setAttribute('data-record-id', recordId);
            
            // 打开模态框
            openModal('auditModal');
        }

        // 提交审核
        function submitAudit() {
            const modal = document.getElementById('auditModal');
            const recordId = modal.getAttribute('data-record-id');
            const auditResult = document.getElementById('auditResult').value;
            const auditComment = document.getElementById('auditComment').value.trim();
            
            if (!auditResult) {
                alert('请选择审核结果');
                return;
            }
            
            // 查找对应的行
            const tbody = document.getElementById('advanceFundingTableBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            let targetRow = null;
            for (let row of rows) {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0 && cells[0].textContent.trim() === recordId) {
                    targetRow = row;
                    break;
                }
            }
            
            if (!targetRow) {
                alert('未找到该记录');
                return;
            }
            
            const cells = targetRow.querySelectorAll('td');
            if (cells.length < 15) {
                alert('记录数据不完整');
                return;
            }
            
            // 更新状态、审核人、审核时间
            const statusCell = cells[8];
            const approverCell = cells[11];
            const approveTimeCell = cells[12];
            const remarkCell = cells[13];
            const operationCell = cells[14];
            
            const currentTime = formatDateTime();
            const auditor = '当前用户'; // 可以从登录信息获取
            
            if (auditResult === 'approved') {
                // 审核通过
                statusCell.innerHTML = '<span class="badge badge-success">已审核</span>';
                approverCell.textContent = auditor;
                approveTimeCell.textContent = currentTime;
                if (auditComment) {
                    remarkCell.textContent = auditComment;
                }
            } else if (auditResult === 'rejected') {
                // 审核拒绝
                statusCell.innerHTML = '<span class="badge" style="background: #f56c6c; color: white;">已拒绝</span>';
                approverCell.textContent = auditor;
                approveTimeCell.textContent = currentTime;
                if (auditComment) {
                    remarkCell.textContent = '拒绝原因：' + auditComment;
                }
            } else if (auditResult === 'cancelled') {
                // 审核取消
                statusCell.innerHTML = '<span class="badge" style="background: #909399; color: white;">已取消</span>';
                approverCell.textContent = auditor;
                approveTimeCell.textContent = currentTime;
                if (auditComment) {
                    remarkCell.textContent = '取消原因：' + auditComment;
                }
            }
            
            // 更新操作列 - 根据状态显示不同的操作按钮
            const statusBadge = statusCell.querySelector('.badge');
            const statusText = statusBadge ? statusBadge.textContent.trim() : statusCell.textContent.trim();
            const mainProject = cells[2].textContent.trim();
            const subProject = cells[3].textContent.trim();
            
            if (statusText === '已审核' || statusText === '已拒绝' || statusText === '已取消') {
                // 已审核/拒绝/取消的记录，不显示审核按钮
                operationCell.innerHTML = `
                    <span class="link-btn" onclick="event.stopPropagation(); openModal('repaymentModal', '${mainProject}', '${subProject}')" style="margin-right: 10px;">申请还款/空投</span>
                    <span class="link-btn" onclick="event.stopPropagation(); cancelRecord('${recordId}')">取消</span>
                `;
            } else {
                // 待审核的记录，显示审核按钮
                operationCell.innerHTML = `
                    <span class="link-btn" onclick="event.stopPropagation(); openAuditModal('${recordId}')" style="margin-right: 10px; color: #409eff;">审核</span>
                    <span class="link-btn" onclick="event.stopPropagation(); openModal('repaymentModal', '${mainProject}', '${subProject}')" style="margin-right: 10px;">申请还款/空投</span>
                    <span class="link-btn" onclick="event.stopPropagation(); cancelRecord('${recordId}')">取消</span>
                `;
            }
            
            const resultText = auditResult === 'approved' ? '通过' : auditResult === 'rejected' ? '拒绝' : '取消';
            alert(`审核${resultText}成功！`);
            closeModal('auditModal');
            
            // 如果审核通过，同步更新资金池页面
            if (auditResult === 'approved') {
                updateFundsPoolFromAdvanceRecords();
            }
        }

        // 根据项目垫资记录计算并更新资金池页面
        function updateFundsPoolFromAdvanceRecords() {
            const advanceTbody = document.getElementById('advanceFundingTableBody');
            const poolTbody = document.getElementById('fundsPoolTableBody');
            if (!advanceTbody) {
                console.error('updateFundsPoolFromAdvanceRecords: 找不到 advanceFundingTableBody');
                return;
            }
            if (!poolTbody) {
                console.error('updateFundsPoolFromAdvanceRecords: 找不到 fundsPoolTableBody');
                return;
            }
            console.log('updateFundsPoolFromAdvanceRecords: 找到', advanceTbody.querySelectorAll('tr').length, '条记录');
            
            // 存储项目统计数据 {主项目-子项目: {数据}}
            const projectStats = {};
            
            // 遍历项目垫资表的所有记录
            const advanceRows = advanceTbody.querySelectorAll('tr');
            advanceRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 15) return;
                
                const mainProject = cells[2]?.textContent.trim();
                const subProject = cells[3]?.textContent.trim();
                const coin = cells[4]?.textContent.trim();
                const amountText = cells[5]?.textContent.trim().replace(/,/g, '');
                const type = cells[7]?.textContent.trim();
                const statusBadge = cells[8]?.querySelector('.badge');
                const status = statusBadge ? statusBadge.textContent.trim() : '';
                const applicant = cells[9]?.textContent.trim();
                const applyTime = cells[10]?.textContent.trim();
                
                // 只统计已审核的记录
                if (status !== '已审核') return;
                
                const projectKey = `${mainProject}-${subProject}`;
                if (!projectStats[projectKey]) {
                    projectStats[projectKey] = {
                        mainProject: mainProject,
                        subProject: subProject,
                        advanceAmount: 0,      // 稳定币垫资金额
                        repaymentAmount: 0,    // 稳定币还款金额
                        airdropAmount: 0,      // 空投收益
                        startTime: applyTime,  // 最早的时间作为开始时间
                        manager: applicant || '未知',
                        nonStableAdvance: {},  // 非稳定币垫资 {币种: 数量}
                        nonStableRepayment: {} // 非稳定币还款 {币种: 数量}
                    };
                }
                
                const amount = parseFloat(amountText) || 0;
                const coinUpper = coin.toUpperCase();
                const isNonStable = nonStableCoins.includes(coinUpper);
                
                // 更新项目负责人（取第一个申请人的名字）
                if (!projectManagers[projectKey] && applicant) {
                    projectManagers[projectKey] = applicant;
                }
                
                // 根据类型累加（区分稳定币和非稳定币）
                if (type === '项目垫资') {
                    if (isNonStable) {
                        // 非稳定币垫资
                        if (!projectStats[projectKey].nonStableAdvance[coinUpper]) {
                            projectStats[projectKey].nonStableAdvance[coinUpper] = 0;
                        }
                        projectStats[projectKey].nonStableAdvance[coinUpper] += amount;
                    } else {
                        // 稳定币垫资
                        projectStats[projectKey].advanceAmount += amount;
                    }
                } else if (type === '项目还款') {
                    if (isNonStable) {
                        // 非稳定币还款
                        if (!projectStats[projectKey].nonStableRepayment[coinUpper]) {
                            projectStats[projectKey].nonStableRepayment[coinUpper] = 0;
                        }
                        projectStats[projectKey].nonStableRepayment[coinUpper] += amount;
                    } else {
                        // 稳定币还款
                        projectStats[projectKey].repaymentAmount += amount;
                    }
                } else if (type === '空投归集') {
                    projectStats[projectKey].airdropAmount += amount;
                }
                
                // 更新开始时间（取最早的时间）
                if (applyTime && (!projectStats[projectKey].startTime || applyTime < projectStats[projectKey].startTime)) {
                    projectStats[projectKey].startTime = applyTime;
                }
            });
            
            // 先读取现有资金池表格，保留项目编号映射
            const existingProjectIds = {};
            const existingRows = poolTbody.querySelectorAll('tr');
            existingRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 3) {
                    const projectId = cells[0]?.textContent.trim();
                    const mainProject = cells[1]?.textContent.trim();
                    const subProject = cells[2]?.textContent.trim();
                    if (projectId && mainProject && subProject) {
                        const projectKey = `${mainProject}-${subProject}`;
                        existingProjectIds[projectKey] = projectId;
                    }
                }
            });
            
            // 计算主项目的等效APY（按主项目维度）
            const mainProjectStats = {}; // {主项目名: {总净利润, 总加权平均占用, 总天数, 交易记录}}
            const now = new Date();
            
            // 第一步：汇总主项目数据
            Object.keys(projectStats).forEach(projectKey => {
                const stats = projectStats[projectKey];
                const mainProject = stats.mainProject;
                
                if (!mainProjectStats[mainProject]) {
                    mainProjectStats[mainProject] = {
                        totalAdvanceAmount: 0,
                        totalRepaymentAmount: 0,
                        totalAirdropAmount: 0,
                        startTime: stats.startTime,
                        transactions: []
                    };
                }
                
                // 累加主项目的稳定币数据
                mainProjectStats[mainProject].totalAdvanceAmount += stats.advanceAmount;
                mainProjectStats[mainProject].totalRepaymentAmount += stats.repaymentAmount;
                mainProjectStats[mainProject].totalAirdropAmount += stats.airdropAmount;
                
                // 更新主项目最早开始时间
                if (stats.startTime && (!mainProjectStats[mainProject].startTime || stats.startTime < mainProjectStats[mainProject].startTime)) {
                    mainProjectStats[mainProject].startTime = stats.startTime;
                }
                
                // 收集主项目下所有子项目的交易记录
                advanceRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length < 15) return;
                    
                    const rowMainProject = cells[2]?.textContent.trim();
                    const rowCoin = cells[4]?.textContent.trim();
                    const rowAmountText = cells[5]?.textContent.trim().replace(/,/g, '');
                    const rowType = cells[7]?.textContent.trim();
                    const rowStatusBadge = cells[8]?.querySelector('.badge');
                    const rowStatus = rowStatusBadge ? rowStatusBadge.textContent.trim() : '';
                    const rowApplyTime = cells[10]?.textContent.trim();
                    
                    // 只统计已审核的稳定币记录
                    if (rowStatus !== '已审核') return;
                    if (rowMainProject !== mainProject) return;
                    const rowCoinUpper = rowCoin.toUpperCase();
                    if (nonStableCoins.includes(rowCoinUpper)) return;
                    
                    const rowAmount = parseFloat(rowAmountText) || 0;
                    if (rowAmount <= 0 || !rowApplyTime) return;
                    
                    let amountChange = 0;
                    if (rowType === '项目垫资') {
                        amountChange = rowAmount;
                    } else if (rowType === '项目还款') {
                        amountChange = -rowAmount;
                    } else {
                        return;
                    }
                    
                    mainProjectStats[mainProject].transactions.push({
                        time: new Date(rowApplyTime),
                        amountChange: amountChange
                    });
                });
            });
            
            // 第二步：计算每个主项目的等效APY
            Object.keys(mainProjectStats).forEach(mainProject => {
                const mainStats = mainProjectStats[mainProject];
                
                // 计算主项目总净利润
                const mainProjectCost = mainStats.totalAdvanceAmount - mainStats.totalRepaymentAmount;
                const mainNetProfit = mainStats.totalAirdropAmount - mainProjectCost;
                
                // 计算主项目总天数
                let mainProjectDays = 0;
                let mainStartDate = null;
                if (mainStats.startTime) {
                    mainStartDate = new Date(mainStats.startTime);
                    const diffTime = Math.abs(now - mainStartDate);
                    mainProjectDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                }
                
                // 计算主项目总加权平均占用
                let mainWeightedAvgOccupancy = 0;
                if (mainStartDate && mainProjectDays > 0 && mainStats.transactions.length > 0) {
                    // 去重并按时间排序交易记录
                    const uniqueTransactions = [];
                    const transactionMap = new Map();
                    mainStats.transactions.forEach(t => {
                        const timeKey = t.time.getTime();
                        if (!transactionMap.has(timeKey)) {
                            transactionMap.set(timeKey, t);
                            uniqueTransactions.push(t);
                        } else {
                            // 同一时间的交易累加
                            transactionMap.get(timeKey).amountChange += t.amountChange;
                        }
                    });
                    uniqueTransactions.sort((a, b) => a.time - b.time);
                    
                    // 计算加权平均占用
                    let totalWeightedBalance = 0;
                    let currentBalance = 0;
                    let prevDate = mainStartDate;
                    
                    for (let i = 0; i <= uniqueTransactions.length; i++) {
                        let nextDate = now;
                        if (i < uniqueTransactions.length) {
                            nextDate = uniqueTransactions[i].time;
                        }
                        
                        const daysInPeriod = Math.ceil(Math.abs(nextDate - prevDate) / (1000 * 60 * 60 * 24));
                        if (daysInPeriod > 0 && currentBalance > 0) {
                            totalWeightedBalance += currentBalance * daysInPeriod;
                        }
                        
                        if (i < uniqueTransactions.length) {
                            currentBalance += uniqueTransactions[i].amountChange;
                            if (currentBalance < 0) currentBalance = 0;
                            prevDate = nextDate;
                        } else {
                            prevDate = nextDate;
                        }
                    }
                    
                    mainWeightedAvgOccupancy = totalWeightedBalance / mainProjectDays;
                }
                
                if (mainWeightedAvgOccupancy <= 0) {
                    mainWeightedAvgOccupancy = mainStats.totalAdvanceAmount;
                }
                
                // 计算主项目等效APY
                let mainEquivalentAPY = 0;
                if (mainWeightedAvgOccupancy > 0 && mainProjectDays > 0) {
                    mainEquivalentAPY = (mainNetProfit / mainWeightedAvgOccupancy) * (365 / mainProjectDays) * 100;
                }
                
                // 将主项目的等效APY存储到所有子项目中
                Object.keys(projectStats).forEach(projectKey => {
                    if (projectStats[projectKey].mainProject === mainProject) {
                        projectStats[projectKey].mainEquivalentAPY = mainEquivalentAPY;
                        projectStats[projectKey].mainWeightedAvgOccupancy = mainWeightedAvgOccupancy;
                        projectStats[projectKey].mainProjectDays = mainProjectDays;
                    }
                });
            });
            
            // 清空资金池表格（保留表头）
            poolTbody.innerHTML = '';
            
            console.log('准备生成资金池数据，项目数量:', Object.keys(projectStats).length);
            console.log('项目列表:', Object.keys(projectStats));
            
            // 为每个项目生成或查找对应的行
            Object.keys(projectStats).forEach(projectKey => {
                const stats = projectStats[projectKey];
                
                // 使用现有的项目编号，如果没有则生成新的
                let projectId = existingProjectIds[projectKey];
                if (!projectId) {
                    projectId = `P${projectIdCounter++}`;
                }
                
                // 计算统计数据
                const projectCost = stats.advanceAmount - stats.repaymentAmount; // 项目成本
                const netProfit = stats.airdropAmount - projectCost; // 净利润
                
                // 计算项目天数（从开始时间到现在）
                let projectDays = 45; // 默认值
                const now = new Date();
                let startDate = null;
                if (stats.startTime) {
                    startDate = new Date(stats.startTime);
                    const diffTime = Math.abs(now - startDate);
                    projectDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                }
                
                // 计算加权平均占用资金（基于每日资金余额）
                // 公式：加权平均占用 = sum(每日资金余额 × 持续天数) / 项目总天数
                let weightedAvgOccupancy = 0;
                if (startDate && projectDays > 0) {
                    // 收集所有已审核的稳定币垫资和还款记录，按时间排序
                    const transactions = [];
                    advanceRows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length < 15) return;
                        
                        const rowMainProject = cells[2]?.textContent.trim();
                        const rowSubProject = cells[3]?.textContent.trim();
                        if (rowMainProject !== stats.mainProject || rowSubProject !== stats.subProject) return;
                        
                        const rowCoin = cells[4]?.textContent.trim();
                        const rowAmountText = cells[5]?.textContent.trim().replace(/,/g, '');
                        const rowType = cells[7]?.textContent.trim();
                        const rowStatusBadge = cells[8]?.querySelector('.badge');
                        const rowStatus = rowStatusBadge ? rowStatusBadge.textContent.trim() : '';
                        const rowApplyTime = cells[10]?.textContent.trim();
                        
                        // 只统计已审核的稳定币记录
                        if (rowStatus !== '已审核') return;
                        const rowCoinUpper = rowCoin.toUpperCase();
                        if (nonStableCoins.includes(rowCoinUpper)) return; // 跳过非稳定币
                        
                        const rowAmount = parseFloat(rowAmountText) || 0;
                        if (rowAmount <= 0 || !rowApplyTime) return;
                        
                        // 确定交易类型和金额变化
                        let amountChange = 0;
                        if (rowType === '项目垫资') {
                            amountChange = rowAmount; // 垫资增加余额
                        } else if (rowType === '项目还款') {
                            amountChange = -rowAmount; // 还款减少余额
                        } else {
                            return; // 空投归集不影响资金占用余额
                        }
                        
                        transactions.push({
                            time: new Date(rowApplyTime),
                            amountChange: amountChange
                        });
                    });
                    
                    // 按时间排序
                    transactions.sort((a, b) => a.time - b.time);
                    
                    // 计算每日资金余额的加权和
                    let totalWeightedBalance = 0; // sum(每日资金余额 × 持续天数)
                    let currentBalance = 0; // 当前资金余额
                    
                    // 从项目开始时间到现在，按时间段计算
                    let prevDate = startDate;
                    for (let i = 0; i <= transactions.length; i++) {
                        let nextDate = now;
                        if (i < transactions.length) {
                            nextDate = transactions[i].time;
                        }
                        
                        // 计算这个时间段的持续天数
                        const daysInPeriod = Math.ceil(Math.abs(nextDate - prevDate) / (1000 * 60 * 60 * 24));
                        if (daysInPeriod > 0 && currentBalance > 0) {
                            // 累加：余额 × 持续天数
                            totalWeightedBalance += currentBalance * daysInPeriod;
                        }
                        
                        // 如果有交易，更新余额
                        if (i < transactions.length) {
                            currentBalance += transactions[i].amountChange;
                            if (currentBalance < 0) currentBalance = 0; // 余额不能为负
                            prevDate = nextDate;
                        } else {
                            prevDate = nextDate;
                        }
                    }
                    
                    // 加权平均占用 = sum(每日资金余额 × 持续天数) / 项目总天数
                    weightedAvgOccupancy = totalWeightedBalance / projectDays;
                } else {
                    // 如果没有开始时间，使用简化计算
                    weightedAvgOccupancy = stats.advanceAmount;
                }
                
                // 如果加权平均占用为0，使用垫资金额作为后备
                if (weightedAvgOccupancy <= 0) {
                    weightedAvgOccupancy = stats.advanceAmount;
                }
                
                // 使用主项目级别的等效APY（已在前面计算并存储到stats.mainEquivalentAPY）
                const equivalentAPY = stats.mainEquivalentAPY || 0;
                const actualProjectDays = stats.mainProjectDays || projectDays;
                const finalWeightedAvgOccupancy = stats.mainWeightedAvgOccupancy || weightedAvgOccupancy;
                
                // 格式化金额显示
                const formatAmount = (num) => {
                    if (num === 0) return '$0';
                    const sign = num >= 0 ? '' : '-';
                    const absNum = Math.abs(num);
                    return `${sign}$${absNum.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
                };
                
                // 格式化APY显示
                const formatAPY = (apy) => {
                    const sign = apy >= 0 ? '' : '-';
                    const absApy = Math.abs(apy);
                    return `${sign}${absApy.toFixed(2)}%`;
                };
                
                // 确定项目状态（优先使用存储的状态，否则根据业务逻辑判断）
                let statusText = projectStatuses[projectKey] || '';
                if (!statusText) {
                    // 如果没有存储的状态，根据业务逻辑判断
                    if (projectCost <= 0 && stats.airdropAmount > 0) {
                        statusText = '待审计';
                    } else {
                        statusText = '进行中';
                    }
                }
                
                let statusBadge = '';
                if (statusText === '进行中') {
                    statusBadge = '<span class="badge badge-info">进行中</span>';
                } else if (statusText === '待审计') {
                    statusBadge = '<span class="badge badge-warning">待审计</span>';
                } else if (statusText === '已完结') {
                    statusBadge = '<span class="badge badge-success">已完结</span>';
                } else if (statusText === '已取消') {
                    statusBadge = '<span class="badge" style="background: #909399; color: white;">已取消</span>';
                } else {
                    statusBadge = '<span class="badge badge-info">进行中</span>';
                }
                
                // 检查是否垫资非稳定币
                const hasNonStableAdvance = stats.nonStableAdvance && Object.keys(stats.nonStableAdvance).length > 0;
                const hasNonStableAdvanceBadge = hasNonStableAdvance 
                    ? '<span class="badge" style="background: #e6a23c; color: white;">是</span>' 
                    : '<span class="badge badge-normal">否</span>';
                
                // 检查非稳定币是否全部归还
                let allNonStableReturned = true;
                if (hasNonStableAdvance) {
                    Object.keys(stats.nonStableAdvance).forEach(coin => {
                        const advance = stats.nonStableAdvance[coin] || 0;
                        const repayment = (stats.nonStableRepayment && stats.nonStableRepayment[coin]) || 0;
                        if (advance - repayment > 0.0001) { // 允许小的误差
                            allNonStableReturned = false;
                        }
                    });
                } else {
                    allNonStableReturned = true; // 没有非稳定币垫资，视为已归还
                }
                const nonStableReturnedBadge = allNonStableReturned 
                    ? '<span class="badge badge-success">已归还</span>' 
                    : '<span class="badge" style="background: #f56c6c; color: white;">未归还</span>';
                
                // 创建表格行
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${projectId}</td>
                    <td>${stats.mainProject}</td>
                    <td>${stats.subProject}</td>
                    <td class="text-right ${projectCost > 0 ? 'text-red' : ''}">${formatAmount(projectCost)}</td>
                    <td class="text-right">${formatAmount(stats.airdropAmount)}</td>
                    <td class="text-right ${netProfit >= 0 ? 'text-green' : 'text-red'}">${formatAmount(netProfit)}</td>
                    <td class="text-right">${formatAmount(finalWeightedAvgOccupancy)}</td>
                    <td class="text-right">${actualProjectDays} 天</td>
                    <td class="text-right ${equivalentAPY >= 0 ? 'text-green' : 'text-red'}" title="等效APY（资金效率视角，按主项目维度计算）：本APY基于阶段性本金释放计算，不等同于全额本金占用型项目">${formatAPY(equivalentAPY)} <span style="font-size: 11px; color: #909399;">*</span></td>
                    <td class="text-center">
                        ${statusBadge}
                        <span class="badge badge-reminder">📅 飞书提醒</span>
                    </td>
                    <td>${projectManagers[projectKey] || stats.manager}</td>
                    <td class="text-center">${hasNonStableAdvanceBadge}</td>
                    <td class="text-center">${nonStableReturnedBadge}</td>
                    <td class="text-center">
                        ${hasNonStableAdvance ? `<span class="link-btn non-stable-btn" style="cursor: pointer; margin-right: 5px;" data-project-id="${projectId}" data-main-project="${stats.mainProject}" data-sub-project="${stats.subProject}">非稳定币</span>` : ''}
                        <span class="link-btn detail-btn" style="cursor: pointer;">垫资详情</span>
                    </td>
                `;
                
                // 绑定行点击事件
                row.addEventListener('click', function(e) {
                    // 如果点击的是操作列的按钮，不触发行点击
                    if (e.target.closest('.detail-btn') || e.target.closest('.non-stable-btn')) {
                        return;
                    }
                    if (typeof window.showDetail === 'function') {
                        window.showDetail(projectId, stats.mainProject, stats.subProject);
                    } else {
                        console.error('showDetail函数未找到');
                    }
                });
                
                // 绑定垫资详情按钮点击事件
                const detailBtn = row.querySelector('.detail-btn');
                if (detailBtn) {
                    detailBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('点击垫资详情按钮:', projectId, stats.mainProject, stats.subProject);
                        if (typeof window.showDetail === 'function') {
                            window.showDetail(projectId, stats.mainProject, stats.subProject);
                        } else {
                            console.error('showDetail函数未找到');
                            alert('showDetail函数未找到，请刷新页面重试');
                        }
                    });
                }
                
                // 绑定非稳定币详情按钮点击事件
                const nonStableBtn = row.querySelector('.non-stable-btn');
                if (nonStableBtn) {
                    nonStableBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('点击非稳定币按钮:', projectId, stats.mainProject, stats.subProject);
                        const projectIdAttr = this.getAttribute('data-project-id');
                        const mainProjectAttr = this.getAttribute('data-main-project');
                        const subProjectAttr = this.getAttribute('data-sub-project');
                        if (typeof window.openNonStableDetailModal === 'function') {
                            window.openNonStableDetailModal(projectIdAttr, mainProjectAttr, subProjectAttr, stats.nonStableAdvance, stats.nonStableRepayment);
                        } else {
                            console.error('openNonStableDetailModal函数未找到');
                            alert('openNonStableDetailModal函数未找到，请刷新页面重试');
                        }
                    });
                }
                
                // 绑定状态变更按钮点击事件
                const statusBtn = row.querySelector('.status-btn');
                if (statusBtn) {
                    statusBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const projectIdAttr = this.getAttribute('data-project-id');
                        const mainProjectAttr = this.getAttribute('data-main-project');
                        const subProjectAttr = this.getAttribute('data-sub-project');
                        if (typeof openStatusChangeModal === 'function') {
                            openStatusChangeModal(projectIdAttr, mainProjectAttr, subProjectAttr);
                        } else {
                            console.error('openStatusChangeModal函数未找到');
                            alert('openStatusChangeModal函数未找到，请刷新页面重试');
                        }
                    });
                }
                
                poolTbody.appendChild(row);
            });
            
            console.log('资金池数据生成完成，共', poolTbody.querySelectorAll('tr').length, '行');
        }

        // 初始化：默认显示项目垫资页面
        document.addEventListener('DOMContentLoaded', function() {
            // 默认显示项目垫资页面
            showPage('advanceFundingPage');
            
            // 阻止模态框内容区域的点击事件冒泡
            document.querySelectorAll('.modal-content').forEach(content => {
                content.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
            });
            
            // 初始化还款模态框的类型切换
            toggleRepaymentType();
            
            // 事件委托：处理表格中取消按钮的点击（针对静态HTML中的按钮）
            const tbody = document.getElementById('advanceFundingTableBody');
            if (tbody) {
                tbody.addEventListener('click', function(event) {
                    const target = event.target;
                    // 检查是否是取消按钮（link-btn且没有onclick属性，或者onclick中没有cancelRecord）
                    if (target.classList.contains('link-btn') && 
                        target.textContent.trim() === '取消' && 
                        (!target.getAttribute('onclick') || !target.getAttribute('onclick').includes('cancelRecord'))) {
                        event.stopPropagation();
                        
                        // 找到该行的recordId
                        const row = target.closest('tr');
                        if (row) {
                            const cells = row.querySelectorAll('td');
                            if (cells.length > 0) {
                                const recordId = cells[0].textContent.trim();
                                cancelRecord(recordId);
                            }
                        }
                    }
                });
            }
            
            // 初始化资金池数据（从项目垫资数据同步）
            // 延迟执行确保DOM完全加载
            setTimeout(function() {
                try {
                    console.log('开始初始化数据...');
                    updateFundsPoolFromAdvanceRecords();
                    refreshAuditPage();
                    console.log('数据初始化完成');
                } catch (error) {
                    console.error('初始化数据时出错:', error);
                }
            }, 500);
        });

        // 加载并显示主项目下的所有申请记录和资金统计
        function loadAuditProjectRecords(mainProject) {
            const advanceTbody = document.getElementById('advanceFundingTableBody');
            const recordsTableBody = document.getElementById('auditRecordsTableBody');
            const coinStatsTableBody = document.getElementById('auditCoinStatsTableBody');
            
            if (!advanceTbody || !recordsTableBody || !coinStatsTableBody) return;
            
            // 存储该主项目下的所有申请记录
            const allRecords = [];
            // 存储按币种统计的数据 {币种: {advance: 0, repayment: 0, airdrop: 0}}
            const coinStats = {};
            
            // 遍历项目垫资表的所有记录
            const advanceRows = advanceTbody.querySelectorAll('tr');
            advanceRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 15) return;
                
                const rowMainProject = cells[2]?.textContent.trim();
                const rowSubProject = cells[3]?.textContent.trim();
                
                // 只显示该主项目下的记录（包含所有子项目）
                if (rowMainProject !== mainProject) return;
                
                const recordId = cells[0]?.textContent.trim();
                const item = cells[1]?.textContent.trim();
                const coin = cells[4]?.textContent.trim();
                const amountText = cells[5]?.textContent.trim().replace(/,/g, '');
                const chain = cells[6]?.textContent.trim();
                const type = cells[7]?.textContent.trim();
                const statusBadge = cells[8]?.querySelector('.badge');
                const status = statusBadge ? statusBadge.textContent.trim() : '';
                const applicant = cells[9]?.textContent.trim();
                const applyTime = cells[10]?.textContent.trim();
                
                const amount = parseFloat(amountText) || 0;
                const coinUpper = coin.toUpperCase();
                
                // 添加到记录列表
                allRecords.push({
                    recordId, item, rowSubProject, coin, amount, chain, type, status, applicant, applyTime
                });
                
                // 只统计已审核的记录
                if (status === '已审核') {
                    // 初始化币种统计
                    if (!coinStats[coinUpper]) {
                        coinStats[coinUpper] = { advance: 0, repayment: 0, airdrop: 0 };
                    }
                    
                    // 按类型累加
                    if (type === '项目垫资') {
                        coinStats[coinUpper].advance += amount;
                    } else if (type === '项目还款') {
                        coinStats[coinUpper].repayment += amount;
                    } else if (type === '空投归集') {
                        coinStats[coinUpper].airdrop += amount;
                    }
                }
            });
            
            // 显示申请记录表格
            if (allRecords.length === 0) {
                recordsTableBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px; color: #909399;">暂无申请记录</td></tr>';
            } else {
                recordsTableBody.innerHTML = allRecords.map(record => {
                    let statusBadge = '';
                    if (record.status === '已审核') {
                        statusBadge = '<span class="badge badge-success">已审核</span>';
                    } else if (record.status === '待审核') {
                        statusBadge = '<span class="badge" style="background: #e6a23c; color: white;">待审核</span>';
                    } else if (record.status === '已拒绝') {
                        statusBadge = '<span class="badge" style="background: #f56c6c; color: white;">已拒绝</span>';
                    } else if (record.status === '已取消') {
                        statusBadge = '<span class="badge" style="background: #909399; color: white;">已取消</span>';
                    } else {
                        statusBadge = `<span class="badge">${record.status || '-'}</span>`;
                    }
                    
                    return `
                        <tr>
                            <td>${record.recordId}</td>
                            <td>${record.item || '-'}</td>
                            <td>${record.rowSubProject}</td>
                            <td>${record.coin.toLowerCase()}</td>
                            <td class="text-right">${formatNumber(record.amount)}</td>
                            <td>${record.chain.toLowerCase()}</td>
                            <td>${record.type}</td>
                            <td class="text-center">${statusBadge}</td>
                            <td>${record.applicant || '-'}</td>
                            <td>${record.applyTime ? record.applyTime.replace('T', ' ') : '-'}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            // 显示币种统计表格
            const coinList = Object.keys(coinStats).sort();
            if (coinList.length === 0) {
                coinStatsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #909399;">暂无统计数据</td></tr>';
            } else {
                coinStatsTableBody.innerHTML = coinList.map(coin => {
                    const stat = coinStats[coin];
                    const diff = stat.advance - stat.repayment;
                    return `
                        <tr>
                            <td><strong>${coin}</strong></td>
                            <td class="text-right">${formatNumber(stat.advance)}</td>
                            <td class="text-right">${formatNumber(stat.repayment)}</td>
                            <td class="text-right">${formatNumber(stat.airdrop)}</td>
                            <td class="text-right ${diff > 0 ? 'text-red' : diff < 0 ? 'text-green' : ''}">${formatNumber(diff)}</td>
                        </tr>
                    `;
                }).join('');
            }
        }
        
        // 打开项目审计模态框（确保在全局作用域）
        window.openProjectAuditModal = function(projectId, mainProject, subProject, stats) {
            const projectKey = `${mainProject}-${subProject}`;
            const auditRecords = projectAuditRecords[projectKey] || [];
            
            // 填充项目信息
            document.getElementById('auditProjectId').value = projectId || '';
            document.getElementById('auditMainProjectName').value = mainProject || '';
            document.getElementById('auditSubProjectName').value = subProject || '';
            
            // 确定项目状态
            const projectCost = stats.advanceAmount - stats.repaymentAmount;
            let statusText = '进行中';
            if (projectCost <= 0 && stats.airdropAmount > 0) {
                statusText = '待审计';
            }
            document.getElementById('auditProjectStatus').value = statusText;
            
            // 清空表单
            document.getElementById('auditAdvanceReceived').value = '';
            document.getElementById('auditRepaymentReceived').value = '';
            document.getElementById('auditAirdropReceived').value = '';
            document.getElementById('auditExchangeCleared').value = '';
            document.getElementById('auditWalletCleared').value = '';
            document.getElementById('auditResultStatus').value = '';
            document.getElementById('auditCommentText').value = '';
            
            // 加载并显示该主项目下所有子项目的申请记录和资金统计
            loadAuditProjectRecords(mainProject);
            
            // 显示审计历史记录
            const historyList = document.getElementById('auditHistoryList');
            if (auditRecords.length === 0) {
                historyList.innerHTML = '<div style="color: #909399; text-align: center; padding: 20px;">暂无审计记录</div>';
            } else {
                historyList.innerHTML = auditRecords.map((record, index) => {
                    let resultBadge = '';
                    if (record.result === 'passed') {
                        resultBadge = '<span class="badge badge-success">通过</span>';
                    } else if (record.result === 'failed') {
                        resultBadge = '<span class="badge" style="background: #f56c6c; color: white;">不通过</span>';
                    } else if (record.result === 'pending') {
                        resultBadge = '<span class="badge" style="background: #e6a23c; color: white;">待补充</span>';
                    }
                    
                    return `
                        <div style="padding: 10px; border-bottom: 1px solid #ebeef5; ${index === auditRecords.length - 1 ? 'border-bottom: none;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div style="font-weight: 600;">${record.auditor} - ${record.auditTime}</div>
                                ${resultBadge}
                            </div>
                            <div style="font-size: 12px; color: #606266; margin-bottom: 5px;">
                                垫资: ${record.advanceReceived === 'yes' ? '已到账' : record.advanceReceived === 'partial' ? '部分到账' : '未到账'} | 
                                还款: ${record.repaymentReceived === 'yes' ? '已到账' : record.repaymentReceived === 'partial' ? '部分到账' : '未到账'} | 
                                空投: ${record.airdropReceived === 'yes' ? '已到账' : record.airdropReceived === 'partial' ? '部分到账' : '未到账'}
                            </div>
                            <div style="font-size: 12px; color: #606266; margin-bottom: 5px;">
                                交易所: ${record.exchangeCleared === 'yes' ? '已清空' : record.exchangeCleared === 'no' ? '未清空' : '不适用'} | 
                                钱包: ${record.walletCleared === 'yes' ? '已清空' : record.walletCleared === 'no' ? '未清空' : '不适用'}
                            </div>
                            ${record.comment ? `<div style="font-size: 12px; color: #909399; margin-top: 5px;">备注: ${record.comment}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }
            
            // 存储当前项目信息，用于提交
            document.getElementById('projectAuditModal').setAttribute('data-project-key', projectKey);
            document.getElementById('projectAuditModal').setAttribute('data-project-id', projectId);
            
            openModal('projectAuditModal');
        };
        
        // 同时保留原函数名以兼容
        function openProjectAuditModal(projectId, mainProject, subProject, stats) {
            return window.openProjectAuditModal(projectId, mainProject, subProject, stats);
        }
        
        // 提交项目审计
        function submitProjectAudit() {
            const modal = document.getElementById('projectAuditModal');
            const projectKey = modal.getAttribute('data-project-key');
            const projectId = modal.getAttribute('data-project-id');
            
            const advanceReceived = document.getElementById('auditAdvanceReceived').value;
            const repaymentReceived = document.getElementById('auditRepaymentReceived').value;
            const airdropReceived = document.getElementById('auditAirdropReceived').value;
            const exchangeCleared = document.getElementById('auditExchangeCleared').value;
            const walletCleared = document.getElementById('auditWalletCleared').value;
            const result = document.getElementById('auditResultStatus').value;
            const comment = document.getElementById('auditCommentText').value.trim();
            
            // 验证必填项
            if (!advanceReceived || !repaymentReceived || !airdropReceived || !exchangeCleared || !walletCleared || !result) {
                alert('请填写所有必填项');
                return;
            }
            
            // 创建审计记录
            const auditRecord = {
                projectId: projectId,
                mainProject: document.getElementById('auditMainProjectName').value,
                subProject: document.getElementById('auditSubProjectName').value,
                advanceReceived: advanceReceived,
                repaymentReceived: repaymentReceived,
                airdropReceived: airdropReceived,
                exchangeCleared: exchangeCleared,
                walletCleared: walletCleared,
                result: result,
                comment: comment,
                auditor: '当前用户', // 可以从登录信息获取
                auditTime: formatDateTime()
            };
            
            // 保存审计记录
            if (!projectAuditRecords[projectKey]) {
                projectAuditRecords[projectKey] = [];
            }
            projectAuditRecords[projectKey].push(auditRecord);
            
            alert('审计记录提交成功！');
            closeModal('projectAuditModal');
            
            // 如果审计通过，提示可以修改状态为"已完结"
            if (result === 'passed') {
                setTimeout(() => {
                    const changeStatus = confirm('审计已通过！是否将项目状态修改为"已完结"？');
                    if (changeStatus) {
                        openStatusChangeModal(projectId, document.getElementById('auditMainProjectName').value, document.getElementById('auditSubProjectName').value, '已完结');
                    }
                }, 500);
            }
            
            // 刷新审计页面和资金池页面
            refreshAuditPage();
            updateFundsPoolFromAdvanceRecords();
        }
        
        // 打开状态变更模态框
        function openStatusChangeModal(projectId, mainProject, subProject, defaultStatus) {
            const projectKey = `${mainProject}-${subProject}`;
            const currentStatus = projectStatuses[projectKey] || '进行中';
            
            // 如果没有存储的状态，根据业务逻辑判断
            let actualCurrentStatus = currentStatus;
            if (currentStatus === '进行中') {
                // 需要重新计算状态
                const advanceTbody = document.getElementById('advanceFundingTableBody');
                if (advanceTbody) {
                    const advanceRows = advanceTbody.querySelectorAll('tr');
                    let advanceAmount = 0;
                    let repaymentAmount = 0;
                    let airdropAmount = 0;
                    
                    advanceRows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length < 15) return;
                        const rowMainProject = cells[2]?.textContent.trim();
                        const rowSubProject = cells[3]?.textContent.trim();
                        if (rowMainProject !== mainProject || rowSubProject !== subProject) return;
                        
                        const coin = cells[4]?.textContent.trim();
                        const amountText = cells[5]?.textContent.trim().replace(/,/g, '');
                        const type = cells[7]?.textContent.trim();
                        const statusBadge = cells[8]?.querySelector('.badge');
                        const status = statusBadge ? statusBadge.textContent.trim() : '';
                        
                        if (status !== '已审核') return;
                        
                        const amount = parseFloat(amountText) || 0;
                        const coinUpper = coin.toUpperCase();
                        const isNonStable = nonStableCoins.includes(coinUpper);
                        
                        if (type === '项目垫资' && !isNonStable) {
                            advanceAmount += amount;
                        } else if (type === '项目还款' && !isNonStable) {
                            repaymentAmount += amount;
                        } else if (type === '空投归集') {
                            airdropAmount += amount;
                        }
                    });
                    
                    const projectCost = advanceAmount - repaymentAmount;
                    if (projectCost <= 0 && airdropAmount > 0) {
                        actualCurrentStatus = '待审计';
                    }
                }
            }
            
            // 填充项目信息
            document.getElementById('statusProjectId').value = projectId || '';
            document.getElementById('statusMainProject').value = mainProject || '';
            document.getElementById('statusSubProject').value = subProject || '';
            document.getElementById('statusCurrentStatus').value = actualCurrentStatus;
            
            // 检查项目是否有审计记录
            const auditRecords = projectAuditRecords[projectKey] || [];
            const hasAuditRecords = auditRecords.length > 0;
            
            // 获取状态选择下拉框
            const statusSelect = document.getElementById('statusNewStatus');
            
            // 如果未审计，禁用"已完结"选项
            const finishedOption = statusSelect.querySelector('option[value="已完结"]');
            if (finishedOption) {
                if (!hasAuditRecords) {
                    finishedOption.disabled = true;
                    // 如果之前选择了"已完结"，清空选择
                    if (defaultStatus === '已完结') {
                        defaultStatus = '';
                    }
                } else {
                    finishedOption.disabled = false;
                }
            }
            
            // 如果传入了默认状态，则自动选择（但要确保不是已禁用的选项）
            if (defaultStatus && (defaultStatus !== '已完结' || hasAuditRecords)) {
                statusSelect.value = defaultStatus;
            } else {
                statusSelect.value = '';
            }
            
            document.getElementById('statusRemark').value = '';
            
            // 存储当前项目信息，用于提交
            document.getElementById('statusModal').setAttribute('data-project-key', projectKey);
            document.getElementById('statusModal').setAttribute('data-project-id', projectId);
            
            openModal('statusModal');
        }
        
        // 提交状态变更
        function submitStatusChange() {
            const modal = document.getElementById('statusModal');
            const projectKey = modal.getAttribute('data-project-key');
            const projectId = modal.getAttribute('data-project-id');
            const newStatus = document.getElementById('statusNewStatus').value;
            const remark = document.getElementById('statusRemark').value.trim();
            
            if (!newStatus) {
                alert('请选择新状态');
                return;
            }
            
            // 检查如果选择"已完结"，必须有审计记录
            if (newStatus === '已完结') {
                const auditRecords = projectAuditRecords[projectKey] || [];
                if (auditRecords.length === 0) {
                    alert('项目未审计，不能将状态修改为"已完结"！\n请先完成项目审计。');
                    return;
                }
            }
            
            // 保存项目状态
            projectStatuses[projectKey] = newStatus;
            
            alert(`项目状态已变更为"${newStatus}"！`);
            closeModal('statusModal');
            
            // 刷新审计页面和资金池页面
            refreshAuditPage();
            updateFundsPoolFromAdvanceRecords();
        }

        // 刷新项目审计页面
        function refreshAuditPage() {
            const auditTbody = document.getElementById('auditTableBody');
            const advanceTbody = document.getElementById('advanceFundingTableBody');
            if (!auditTbody) {
                console.error('找不到 auditTableBody');
                return;
            }
            if (!advanceTbody) {
                console.error('找不到 advanceFundingTableBody');
                return;
            }
            console.log('开始刷新项目审计页面，找到', advanceTbody.querySelectorAll('tr').length, '条记录');
            
            // 存储项目统计数据 {主项目-子项目: {数据}}
            const projectStats = {};
            
            // 遍历项目垫资表的所有记录
            const advanceRows = advanceTbody.querySelectorAll('tr');
            advanceRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 15) return;
                
                const mainProject = cells[2]?.textContent.trim();
                const subProject = cells[3]?.textContent.trim();
                const coin = cells[4]?.textContent.trim();
                const amountText = cells[5]?.textContent.trim().replace(/,/g, '');
                const type = cells[7]?.textContent.trim();
                const statusBadge = cells[8]?.querySelector('.badge');
                const status = statusBadge ? statusBadge.textContent.trim() : '';
                const applicant = cells[9]?.textContent.trim();
                const applyTime = cells[10]?.textContent.trim();
                
                // 只统计已审核的记录
                if (status !== '已审核') return;
                
                const projectKey = `${mainProject}-${subProject}`;
                if (!projectStats[projectKey]) {
                    projectStats[projectKey] = {
                        mainProject: mainProject,
                        subProject: subProject,
                        advanceAmount: 0,      // 稳定币垫资金额
                        repaymentAmount: 0,    // 稳定币还款金额
                        airdropAmount: 0,      // 空投收益
                        startTime: applyTime,  // 最早的时间作为开始时间
                        manager: applicant || '未知',
                        nonStableAdvance: {},  // 非稳定币垫资 {币种: 数量}
                        nonStableRepayment: {} // 非稳定币还款 {币种: 数量}
                    };
                }
                
                const amount = parseFloat(amountText) || 0;
                const coinUpper = coin.toUpperCase();
                const isNonStable = nonStableCoins.includes(coinUpper);
                
                // 更新项目负责人（取第一个申请人的名字）
                if (!projectManagers[projectKey] && applicant) {
                    projectManagers[projectKey] = applicant;
                }
                
                // 根据类型累加（区分稳定币和非稳定币）
                if (type === '项目垫资') {
                    if (isNonStable) {
                        // 非稳定币垫资
                        if (!projectStats[projectKey].nonStableAdvance[coinUpper]) {
                            projectStats[projectKey].nonStableAdvance[coinUpper] = 0;
                        }
                        projectStats[projectKey].nonStableAdvance[coinUpper] += amount;
                    } else {
                        // 稳定币垫资
                        projectStats[projectKey].advanceAmount += amount;
                    }
                } else if (type === '项目还款') {
                    if (isNonStable) {
                        // 非稳定币还款
                        if (!projectStats[projectKey].nonStableRepayment[coinUpper]) {
                            projectStats[projectKey].nonStableRepayment[coinUpper] = 0;
                        }
                        projectStats[projectKey].nonStableRepayment[coinUpper] += amount;
                    } else {
                        // 稳定币还款
                        projectStats[projectKey].repaymentAmount += amount;
                    }
                } else if (type === '空投归集') {
                    projectStats[projectKey].airdropAmount += amount;
                }
                
                // 更新开始时间（取最早的时间）
                if (applyTime && (!projectStats[projectKey].startTime || applyTime < projectStats[projectKey].startTime)) {
                    projectStats[projectKey].startTime = applyTime;
                }
            });
            
            // 读取现有资金池表格，获取项目编号映射
            const poolTbody = document.getElementById('fundsPoolTableBody');
            const existingProjectIds = {};
            if (poolTbody) {
                const existingRows = poolTbody.querySelectorAll('tr');
                existingRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells.length >= 3) {
                        const projectId = cells[0]?.textContent.trim();
                        const mainProject = cells[1]?.textContent.trim();
                        const subProject = cells[2]?.textContent.trim();
                        if (projectId && mainProject && subProject) {
                            const projectKey = `${mainProject}-${subProject}`;
                            existingProjectIds[projectKey] = projectId;
                        }
                    }
                });
            }
            
            // 清空审计表格
            auditTbody.innerHTML = '';
            
            // 获取所有项目（不再筛选，显示所有项目）
            const allProjects = [];
            Object.keys(projectStats).forEach(projectKey => {
                const stats = projectStats[projectKey];
                allProjects.push({ projectKey, stats });
            });
            
            // 更新总数
            document.getElementById('auditTotalCount').textContent = allProjects.length;
            
            // 为每个项目生成行
            allProjects.forEach(({ projectKey, stats }) => {
                // 使用现有的项目编号，如果没有则生成新的
                let projectId = existingProjectIds[projectKey];
                if (!projectId) {
                    projectId = `P${projectIdCounter++}`;
                }
                
                // 计算统计数据
                const projectCost = stats.advanceAmount - stats.repaymentAmount;
                const netProfit = stats.airdropAmount - projectCost;
                
                // 计算项目天数
                let projectDays = 45;
                const now = new Date();
                let startDate = null;
                if (stats.startTime) {
                    startDate = new Date(stats.startTime);
                    const diffTime = Math.abs(now - startDate);
                    projectDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                }
                
                // 计算加权平均占用资金（基于每日资金余额）
                // 公式：加权平均占用 = sum(每日资金余额 × 持续天数) / 项目总天数
                let weightedAvgOccupancy = 0;
                if (startDate && projectDays > 0) {
                    // 收集所有已审核的稳定币垫资和还款记录，按时间排序
                    const transactions = [];
                    const advanceRows = advanceTbody.querySelectorAll('tr');
                    advanceRows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        if (cells.length < 15) return;
                        
                        const rowMainProject = cells[2]?.textContent.trim();
                        const rowSubProject = cells[3]?.textContent.trim();
                        if (rowMainProject !== stats.mainProject || rowSubProject !== stats.subProject) return;
                        
                        const rowCoin = cells[4]?.textContent.trim();
                        const rowAmountText = cells[5]?.textContent.trim().replace(/,/g, '');
                        const rowType = cells[7]?.textContent.trim();
                        const rowStatusBadge = cells[8]?.querySelector('.badge');
                        const rowStatus = rowStatusBadge ? rowStatusBadge.textContent.trim() : '';
                        const rowApplyTime = cells[10]?.textContent.trim();
                        
                        // 只统计已审核的稳定币记录
                        if (rowStatus !== '已审核') return;
                        const rowCoinUpper = rowCoin.toUpperCase();
                        if (nonStableCoins.includes(rowCoinUpper)) return; // 跳过非稳定币
                        
                        const rowAmount = parseFloat(rowAmountText) || 0;
                        if (rowAmount <= 0 || !rowApplyTime) return;
                        
                        // 确定交易类型和金额变化
                        let amountChange = 0;
                        if (rowType === '项目垫资') {
                            amountChange = rowAmount; // 垫资增加余额
                        } else if (rowType === '项目还款') {
                            amountChange = -rowAmount; // 还款减少余额
                        } else {
                            return; // 空投归集不影响资金占用余额
                        }
                        
                        transactions.push({
                            time: new Date(rowApplyTime),
                            amountChange: amountChange
                        });
                    });
                    
                    // 按时间排序
                    transactions.sort((a, b) => a.time - b.time);
                    
                    // 计算每日资金余额的加权和
                    let totalWeightedBalance = 0; // sum(每日资金余额 × 持续天数)
                    let currentBalance = 0; // 当前资金余额
                    let prevDate = startDate;
                    
                    // 遍历所有交易，计算每个时间段的余额和持续天数
                    for (let i = 0; i <= transactions.length; i++) {
                        let nextDate = now;
                        if (i < transactions.length) {
                            nextDate = transactions[i].time;
                        }
                        
                        // 计算这个时间段的持续天数
                        const daysInPeriod = Math.ceil(Math.abs(nextDate - prevDate) / (1000 * 60 * 60 * 24));
                        if (daysInPeriod > 0 && currentBalance > 0) {
                            // 累加：余额 × 持续天数
                            totalWeightedBalance += currentBalance * daysInPeriod;
                        }
                        
                        // 如果有交易，更新余额
                        if (i < transactions.length) {
                            currentBalance += transactions[i].amountChange;
                            if (currentBalance < 0) currentBalance = 0; // 余额不能为负
                            prevDate = nextDate;
                        } else {
                            prevDate = nextDate;
                        }
                    }
                    
                    // 加权平均占用 = sum(每日资金余额 × 持续天数) / 项目总天数
                    weightedAvgOccupancy = totalWeightedBalance / projectDays;
                }
                
                // 如果加权平均占用为0，使用垫资金额作为后备
                if (weightedAvgOccupancy <= 0) {
                    weightedAvgOccupancy = stats.advanceAmount;
                }
                
                // 计算等效APY（资金效率视角）
                // 公式：等效APY = (净利润 / 加权平均占用) × (365 / 项目天数) × 100%
                // 其中：加权平均占用 = sum(每日资金余额 × 持续天数) / 项目总天数
                let equivalentAPY = 0;
                if (weightedAvgOccupancy > 0 && projectDays > 0) {
                    equivalentAPY = (netProfit / weightedAvgOccupancy) * (365 / projectDays) * 100;
                }
                
                // 格式化金额显示
                const formatAmount = (num) => {
                    if (num === 0) return '$0';
                    const sign = num >= 0 ? '' : '-';
                    const absNum = Math.abs(num);
                    return `${sign}$${absNum.toLocaleString(undefined, {maximumFractionDigits: 0})}`;
                };
                
                // 格式化APY显示
                const formatAPY = (apy) => {
                    const sign = apy >= 0 ? '' : '-';
                    const absApy = Math.abs(apy);
                    return `${sign}${absApy.toFixed(2)}%`;
                };
                
                // 确定项目状态（优先使用存储的状态，否则根据业务逻辑判断）
                let statusText = projectStatuses[projectKey] || '';
                if (!statusText) {
                    // 如果没有存储的状态，根据业务逻辑判断
                    if (projectCost <= 0 && stats.airdropAmount > 0) {
                        statusText = '待审计';
                    } else {
                        statusText = '进行中';
                    }
                }
                
                let statusBadge = '';
                if (statusText === '进行中') {
                    statusBadge = '<span class="badge badge-info">进行中</span>';
                } else if (statusText === '待审计') {
                    statusBadge = '<span class="badge badge-warning">待审计</span>';
                } else if (statusText === '已完结') {
                    statusBadge = '<span class="badge badge-success">已完结</span>';
                } else if (statusText === '已取消') {
                    statusBadge = '<span class="badge" style="background: #909399; color: white;">已取消</span>';
                } else {
                    statusBadge = '<span class="badge badge-info">进行中</span>';
                }
                
                // 获取该项目的审计记录
                const auditRecords = projectAuditRecords[projectKey] || [];
                const latestAudit = auditRecords.length > 0 ? auditRecords[auditRecords.length - 1] : null;
                
                // 显示最新审计结果
                let latestAuditBadge = '<span class="badge badge-normal">未审计</span>';
                if (latestAudit) {
                    if (latestAudit.result === 'passed') {
                        latestAuditBadge = '<span class="badge badge-success">通过</span>';
                    } else if (latestAudit.result === 'failed') {
                        latestAuditBadge = '<span class="badge" style="background: #f56c6c; color: white;">不通过</span>';
                    } else if (latestAudit.result === 'pending') {
                        latestAuditBadge = '<span class="badge" style="background: #e6a23c; color: white;">待补充</span>';
                    }
                }
                
                // 创建表格行
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${projectId}</td>
                    <td>${stats.mainProject}</td>
                    <td>${stats.subProject}</td>
                    <td class="text-right ${projectCost > 0 ? 'text-red' : ''}">${formatAmount(projectCost)}</td>
                    <td class="text-right">${formatAmount(stats.airdropAmount)}</td>
                    <td class="text-right ${netProfit >= 0 ? 'text-green' : 'text-red'}">${formatAmount(netProfit)}</td>
                    <td class="text-right">${formatAmount(weightedAvgOccupancy)}</td>
                    <td class="text-right">${projectDays} 天</td>
                    <td class="text-right ${equivalentAPY >= 0 ? 'text-green' : 'text-red'}" title="等效APY（按主项目维度计算）：等效APY = (主项目总净利润 / 主项目总加权平均占用) × (365 / 主项目总天数) × 100%">${formatAPY(equivalentAPY)} <span style="font-size: 11px; color: #909399;">*</span></td>
                    <td class="text-center">${statusBadge}</td>
                    <td>${projectManagers[projectKey] || stats.manager}</td>
                    <td class="text-center">${latestAuditBadge}</td>
                    <td class="text-center">${auditRecords.length}</td>
                    <td class="text-center">
                        <span class="link-btn audit-btn" style="cursor: pointer; color: #409eff;" data-project-id="${projectId}" data-main-project="${stats.mainProject}" data-sub-project="${stats.subProject}">审计</span>
                        <span class="link-btn detail-btn" style="cursor: pointer; margin-left: 5px;">详情</span>
                        <span class="link-btn status-btn" style="cursor: pointer; margin-left: 5px; color: #67c23a;" data-project-id="${projectId}" data-main-project="${stats.mainProject}" data-sub-project="${stats.subProject}">变更状态</span>
                    </td>
                `;
                
                // 绑定审计按钮点击事件
                const auditBtn = row.querySelector('.audit-btn');
                if (auditBtn) {
                    auditBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const projectIdAttr = this.getAttribute('data-project-id');
                        const mainProjectAttr = this.getAttribute('data-main-project');
                        const subProjectAttr = this.getAttribute('data-sub-project');
                        console.log('点击审计按钮:', projectIdAttr, mainProjectAttr, subProjectAttr);
                        if (typeof window.openProjectAuditModal === 'function') {
                            window.openProjectAuditModal(projectIdAttr, mainProjectAttr, subProjectAttr, stats);
                        } else {
                            console.error('openProjectAuditModal函数未找到');
                            alert('openProjectAuditModal函数未找到，请刷新页面重试');
                        }
                    });
                }
                
                // 绑定详情按钮点击事件
                const detailBtn = row.querySelector('.detail-btn');
                if (detailBtn) {
                    detailBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        if (typeof window.showDetail === 'function') {
                            window.showDetail(projectId, stats.mainProject, stats.subProject);
                        }
                    });
                }
                
                // 绑定状态变更按钮点击事件
                const statusBtn = row.querySelector('.status-btn');
                if (statusBtn) {
                    statusBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const projectIdAttr = this.getAttribute('data-project-id');
                        const mainProjectAttr = this.getAttribute('data-main-project');
                        const subProjectAttr = this.getAttribute('data-sub-project');
                        openStatusChangeModal(projectIdAttr, mainProjectAttr, subProjectAttr);
                    });
                }
                
                auditTbody.appendChild(row);
            });
        }

        function toggleAdvanceWarning() {
            const coin = document.getElementById('advanceCoin').value;
            const warning = document.getElementById('advanceWarning');
            if (coin.includes('ETH') || coin.includes('BNB')) {
                warning.style.display = 'block';
            } else {
                warning.style.display = 'none';
            }
        }

        // 格式化数字，去掉末尾的0，但保留至少一位有效小数（如果是小数的话）
        function formatNumber(num) {
            if (num === 0) return '0';
            // 转换为字符串
            let str = num.toString();
            // 如果是科学计数法，先转换为普通数字
            if (str.includes('e')) {
                num = parseFloat(str);
                str = num.toString();
            }
            // 查找小数点位置
            const decimalIndex = str.indexOf('.');
            if (decimalIndex === -1) {
                // 整数，直接返回
                return str;
            }
            // 有小数部分，去掉末尾的0
            // 但保留小数点（如果小数部分不全为0）
            const trimmed = str.replace(/\.?0+$/, '');
            // 如果去掉0后没有小数部分了，返回整数形式
            return trimmed === str.substring(0, decimalIndex) ? str.substring(0, decimalIndex) : trimmed;
        }

        // 从表格记录中获取该币种金额的原始小数位数（用于参考格式）
        function getDecimalPlacesFromRecords(mainProject, subProject, coin) {
            const tbody = document.getElementById('advanceFundingTableBody');
            if (!tbody) return null;
            
            const rows = tbody.querySelectorAll('tr');
            
            // 查找所有相关的已审核记录，取最大小数位数
            for (let row of rows) {
                const cells = row.querySelectorAll('td');
                if (cells.length < 8) continue;
                
                const rowMainProject = cells[2]?.textContent.trim();
                const rowSubProject = cells[3]?.textContent.trim();
                const rowCoin = cells[4]?.textContent.trim().toUpperCase();
                const amountText = cells[5]?.textContent.trim().replace(/,/g, '');
                const statusBadge = cells[8]?.querySelector('.badge');
                const status = statusBadge ? statusBadge.textContent.trim() : '';
                
                if (rowMainProject === mainProject && rowSubProject === subProject && 
                    rowCoin === coin.toUpperCase() && status === '已审核' && amountText) {
                    // 找到匹配的记录，检查原始文本的小数位数
                    const decimalIndex = amountText.indexOf('.');
                    if (decimalIndex !== -1) {
                        return amountText.length - decimalIndex - 1;
                    }
                }
            }
            
            return null;
        }

        function checkRepaymentDebt() {
            const repaymentType = document.querySelector('input[name="repaymentType"]:checked');
            const type = repaymentType ? repaymentType.value : 'repayment';
            
            // 如果是空投归集，检查空投债务
            if (type === 'airdrop') {
                checkAirdropDebtForRepayment();
                return;
            }
            
            // 项目还款时，只显示提示信息，不阻止提交
            const mainProject = document.getElementById('repaymentMainProject').value;
            const subProject = document.getElementById('repaymentSubProject').value;
            const debtCheck = document.getElementById('repaymentDebtCheck');
            
            if (!mainProject || !subProject) {
                if (debtCheck) {
                    debtCheck.style.display = 'none';
                }
                return;
            }
            
            // 动态计算非稳定币债务
            const debts = calculateNonStableCoinDebt(mainProject, subProject);
            
            if (Object.keys(debts).length > 0) {
                // 有未归还的非稳定币债务，只显示提示信息（不阻止提交）
                const debtListHtml = Object.keys(debts).map(coin => {
                    const debt = debts[coin];
                    // 根据记录中的小数位数格式化
                    const decimals = getDecimalPlacesFromRecords(mainProject, subProject, coin);
                    const diffFormatted = formatNumber(debt.diff);
                    const repaymentFormatted = formatNumber(debt.repayment);
                    return `<div style="margin-bottom: 8px;">${coin}: 欠款 ${diffFormatted} ${coin}，已还款 ${repaymentFormatted} ${coin}</div>`;
                }).join('');
                
                debtCheck.innerHTML = `
                    <div class="alert alert-info">
                        <div class="alert-title">ℹ️ 非稳定币债务信息</div>
                        <div class="alert-content">
                            ${debtListHtml}
                            <div style="margin-top: 10px;">提示：如果本次还款不足以还清所有非稳定币债务，差额部分需要使用稳定币U购买补齐。项目成本 = 还款差值U + 购买非稳定币差值的U</div>
                        </div>
                    </div>
                `;
                debtCheck.style.display = 'block';
            } else {
                if (debtCheck) {
                    debtCheck.style.display = 'none';
                }
            }
        }


        function updateAdvanceSubProjects() {
            const mainProject = document.getElementById('advanceMainProject').value;
            const subProjectSelect = document.getElementById('advanceSubProject');
            if (!subProjectSelect) return;
            subProjectSelect.innerHTML = '<option value="">请先选择主项目</option>';
            
            if (mainProject && projectMapping[mainProject]) {
                projectMapping[mainProject].forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subProjectSelect.appendChild(option);
                });
            }
        }

        function updateRepaymentSubProjects() {
            const mainProject = document.getElementById('repaymentMainProject').value;
            const subProjectSelect = document.getElementById('repaymentSubProject');
            if (!subProjectSelect) return;
            subProjectSelect.innerHTML = '<option value="">请先选择主项目</option>';
            
            if (mainProject && projectMapping[mainProject]) {
                projectMapping[mainProject].forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subProjectSelect.appendChild(option);
                });
            }
        }


        // 生成唯一标识
        function generateRecordId() {
            const prefix = ['D', 'H', 'R'][Math.floor(Math.random() * 3)];
            return prefix + (recordIdCounter++);
        }

        // 格式化时间
        function formatDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
        }

        // 创建新项目
        function submitCreateProject() {
            const mainProjectInput = document.getElementById('createMainProject');
            const subProjectInput = document.getElementById('createSubProject');
            const managerSelect = document.getElementById('createManager');
            const remarkTextarea = document.getElementById('createRemark');
            
            if (!mainProjectInput || !subProjectInput || !managerSelect) {
                alert('表单元素未找到，请刷新页面重试');
                return;
            }
            
            const mainProject = mainProjectInput.value.trim();
            const subProject = subProjectInput.value.trim();
            const manager = managerSelect.value;
            const remark = remarkTextarea ? remarkTextarea.value.trim() : '';

            if (!mainProject || !subProject || !manager) {
                alert('请填写必填项：主项目名称、子项目名称、项目负责人');
                return;
            }

            // 更新项目映射
            if (!projectMapping[mainProject]) {
                projectMapping[mainProject] = [];
            }
            if (!projectMapping[mainProject].includes(subProject)) {
                projectMapping[mainProject].push(subProject);
            }
            
            // 保存项目负责人信息
            const projectKey = `${mainProject}-${subProject}`;
            projectManagers[projectKey] = manager;

            alert(`项目创建成功！\n主项目：${mainProject}\n子项目：${subProject}\n负责人：${manager}\n\n现在可以为该项目申请垫资。`);
            closeModal('createModal');
            
            // 同步更新资金池页面和待审计页面
            updateFundsPoolFromAdvanceRecords();
            refreshAuditPage();
            
            // 清空表单
            mainProjectInput.value = '';
            subProjectInput.value = '';
            managerSelect.value = '';
            if (remarkTextarea) {
                remarkTextarea.value = '';
            }
        }

        // 提交垫资申请
        function submitAdvance() {
            const mainProject = document.getElementById('advanceMainProject').value;
            const subProject = document.getElementById('advanceSubProject').value;
            const chain = document.getElementById('advanceChain').value;
            const coin = document.getElementById('advanceCoin').value;
            const amount = document.getElementById('advanceAmount').value;
            const item = document.getElementById('advanceItem').value.trim();
            const remark = document.getElementById('advanceRemark').value.trim();

            if (!mainProject || !subProject || !chain || !coin || !amount) {
                alert('请填写必填项');
                return;
            }

            // 添加到列表
            const recordId = generateRecordId();
            const applyTime = formatDateTime();
            
            const tbody = document.getElementById('advanceFundingTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${recordId}</td>
                <td>${item || '项目垫资申请'}</td>
                <td>${mainProject}</td>
                <td>${subProject}</td>
                <td>${coin.split(' ')[0].toLowerCase()}</td>
                <td class="text-right">${parseFloat(amount).toLocaleString()}</td>
                <td>${chain.toLowerCase()}</td>
                <td>项目垫资</td>
                <td class="text-center"><span class="badge" style="background: #e6a23c; color: white;">待审核</span></td>
                <td>当前用户</td>
                <td>${applyTime}</td>
                <td>-</td>
                <td>-</td>
                <td>${remark || '-'}</td>
                <td class="text-center">
                    <span class="link-btn" onclick="event.stopPropagation(); openAuditModal('${recordId}')" style="margin-right: 10px; color: #409eff;">审核</span>
                    <span class="link-btn" onclick="event.stopPropagation(); openModal('repaymentModal', '${mainProject}', '${subProject}')" style="margin-right: 10px;">申请还款/空投</span>
                    <span class="link-btn" onclick="event.stopPropagation(); cancelRecord('${recordId}')">取消</span>
                </td>
            `;
            tbody.insertBefore(newRow, tbody.firstChild);

            alert('垫资申请提交成功！等待审核。');
            closeModal('advanceModal');
            
            // 注意：这里不更新资金池，因为记录还未审核
            // 只有在审核通过后才会更新
            
            // 清空表单
            document.getElementById('advanceMainProject').value = '';
            document.getElementById('advanceSubProject').innerHTML = '<option value="">请先选择主项目</option>';
            document.getElementById('advanceChain').value = '';
            document.getElementById('advanceCoin').value = '';
            document.getElementById('advanceAmount').value = '';
            document.getElementById('advanceItem').value = '';
            document.getElementById('advanceRemark').value = '';
            document.getElementById('advanceWarning').style.display = 'none';
        }

        // 切换还款类型（项目还款/空投归集）
        function toggleRepaymentType() {
            const repaymentType = document.querySelector('input[name="repaymentType"]:checked').value;
            const coinLabel = document.getElementById('repaymentCoinLabel');
            const amountLabel = document.getElementById('repaymentAmountLabel');
            const airdropDebtCheck = document.getElementById('repaymentAirdropDebtCheck');
            const submitBtn = document.querySelector('#repaymentModal .btn-primary');
            
            if (repaymentType === 'airdrop') {
                coinLabel.textContent = '空投币种 ' + '<span class="required">*</span>';
                amountLabel.textContent = '空投金额 ' + '<span class="required">*</span>';
                // 检查非稳定币债务
                const mainProject = document.getElementById('repaymentMainProject').value;
                const subProject = document.getElementById('repaymentSubProject').value;
                if (mainProject && subProject) {
                    checkAirdropDebtForRepayment();
                }
            } else {
                // 项目还款：始终允许提交，不阻止
                coinLabel.textContent = '还款币种 ' + '<span class="required">*</span>';
                amountLabel.textContent = '还款金额 ' + '<span class="required">*</span>';
                if (airdropDebtCheck) {
                    airdropDebtCheck.style.display = 'none';
                    airdropDebtCheck.innerHTML = '';
                }
                // 确保提交按钮是启用状态（项目还款时永远允许提交）
                if (submitBtn) {
                    submitBtn.disabled = false;
                }
            }
        }

        // 检查空投归集的债务（在还款模态框中）
        function checkAirdropDebtForRepayment() {
            // 只有在空投归集模式下才执行此检查
            const repaymentType = document.querySelector('input[name="repaymentType"]:checked');
            if (!repaymentType || repaymentType.value !== 'airdrop') {
                // 如果不是空投归集模式，确保按钮可用并返回
                const submitBtn = document.querySelector('#repaymentModal .btn-primary');
                if (submitBtn) submitBtn.disabled = false;
                return;
            }
            
            const mainProject = document.getElementById('repaymentMainProject').value;
            const subProject = document.getElementById('repaymentSubProject').value;
            const airdropDebtCheck = document.getElementById('repaymentAirdropDebtCheck');
            const submitBtn = document.querySelector('#repaymentModal .btn-primary');
            
            if (!mainProject || !subProject) {
                if (airdropDebtCheck) {
                    airdropDebtCheck.style.display = 'none';
                    airdropDebtCheck.innerHTML = '';
                }
                if (submitBtn) submitBtn.disabled = false;
                return;
            }
            
            // 动态计算非稳定币债务
            const debts = calculateNonStableCoinDebt(mainProject, subProject);
            
            if (Object.keys(debts).length > 0) {
                // 有未归还的非稳定币债务
                const debtListHtml = Object.keys(debts).map(coin => {
                    const debt = debts[coin];
                    // 格式化数字，自动去掉末尾的0
                    const diffFormatted = formatNumber(debt.diff);
                    const advanceFormatted = formatNumber(debt.advance);
                    const repaymentFormatted = formatNumber(debt.repayment);
                    return `<div style="margin-bottom: 8px;">${coin}: 欠款 ${diffFormatted} ${coin}（垫资 ${advanceFormatted}，已还款 ${repaymentFormatted}）</div>`;
                }).join('');
                
                airdropDebtCheck.innerHTML = `
                    <div class="alert alert-danger">
                        <div class="alert-title">🚫 无法申请空投收益</div>
                        <div class="alert-content">
                            <div style="margin-bottom: 10px;">该项目存在未归还的非稳定币债务：</div>
                            ${debtListHtml}
                            <div style="margin-top: 10px;">请先归还所有非稳定币债务后，再申请空投收益。</div>
                        </div>
                    </div>
                `;
                airdropDebtCheck.style.display = 'block';
                if (submitBtn) submitBtn.disabled = true;
            } else {
                if (airdropDebtCheck) {
                    airdropDebtCheck.style.display = 'none';
                    airdropDebtCheck.innerHTML = '';
                }
                if (submitBtn) submitBtn.disabled = false;
            }
        }

        // 检查项目是否有已审核的垫资记录
        function hasApprovedAdvance(mainProject, subProject) {
            const tbody = document.getElementById('advanceFundingTableBody');
            if (!tbody) return false;
            
            const rows = tbody.querySelectorAll('tr');
            for (let row of rows) {
                const cells = row.querySelectorAll('td');
                if (cells.length < 15) continue;
                
                const rowMainProject = cells[2]?.textContent.trim();
                const rowSubProject = cells[3]?.textContent.trim();
                const rowType = cells[7]?.textContent.trim();
                const rowStatusBadge = cells[8]?.querySelector('.badge');
                const rowStatus = rowStatusBadge ? rowStatusBadge.textContent.trim() : '';
                
                // 检查是否是项目垫资类型且已审核
                if (rowMainProject === mainProject && rowSubProject === subProject && 
                    rowType === '项目垫资' && rowStatus === '已审核') {
                    return true;
                }
            }
            return false;
        }

        // 获取项目未审核的垫资记录
        function getPendingAdvanceRecords(mainProject, subProject) {
            const tbody = document.getElementById('advanceFundingTableBody');
            if (!tbody) return [];
            
            const pendingRecords = [];
            const rows = tbody.querySelectorAll('tr');
            for (let row of rows) {
                const cells = row.querySelectorAll('td');
                if (cells.length < 15) continue;
                
                const rowMainProject = cells[2]?.textContent.trim();
                const rowSubProject = cells[3]?.textContent.trim();
                const rowType = cells[7]?.textContent.trim();
                const rowStatusBadge = cells[8]?.querySelector('.badge');
                const rowStatus = rowStatusBadge ? rowStatusBadge.textContent.trim() : '';
                
                // 检查是否是项目垫资类型且待审核
                if (rowMainProject === mainProject && rowSubProject === subProject && 
                    rowType === '项目垫资' && rowStatus === '待审核') {
                    const recordId = cells[0]?.textContent.trim();
                    const item = cells[1]?.textContent.trim();
                    const coin = cells[4]?.textContent.trim();
                    const amount = cells[5]?.textContent.trim();
                    const chain = cells[6]?.textContent.trim();
                    const applyTime = cells[10]?.textContent.trim();
                    
                    pendingRecords.push({
                        recordId: recordId,
                        item: item,
                        coin: coin,
                        amount: amount,
                        chain: chain,
                        applyTime: applyTime
                    });
                }
            }
            return pendingRecords;
        }

        // 全局变量，存储当前待确认的还款信息
        let pendingRepaymentData = null;

        // 打开垫资状态确认对话框
        function openAdvanceStatusConfirmModal(mainProject, subProject, repaymentType, callback) {
            const hasApproved = hasApprovedAdvance(mainProject, subProject);
            const pendingRecords = getPendingAdvanceRecords(mainProject, subProject);
            
            const messageEl = document.getElementById('advanceStatusConfirmMessage');
            const pendingRecordsEl = document.getElementById('advanceStatusConfirmPendingRecords');
            const pendingListEl = document.getElementById('advanceStatusConfirmPendingList');
            const verifyBtn = document.getElementById('advanceStatusConfirmVerifyBtn');
            
            if (pendingRecords.length > 0) {
                // 有未审核的垫资记录
                messageEl.textContent = `该项目未审核垫资，请先完成审核后再进行${repaymentType === 'airdrop' ? '空投归集' : '项目还款'}操作。`;
                pendingRecordsEl.style.display = 'block';
                
                let listHTML = '<div style="font-size: 13px;">';
                pendingRecords.forEach(record => {
                    listHTML += `<div style="padding: 8px 0; border-bottom: 1px solid #e4e7ed;">`;
                    listHTML += `<div><strong>唯一标识：</strong>${record.recordId}</div>`;
                    listHTML += `<div><strong>申请事项：</strong>${record.item}</div>`;
                    listHTML += `<div><strong>金额：</strong>${record.amount} ${record.coin.toUpperCase()}</div>`;
                    listHTML += `<div><strong>链：</strong>${record.chain.toUpperCase()}</div>`;
                    listHTML += `<div><strong>申请时间：</strong>${record.applyTime}</div>`;
                    listHTML += `</div>`;
                });
                listHTML += '</div>';
                pendingListEl.innerHTML = listHTML;
                
                verifyBtn.textContent = '去核验';
                verifyBtn.onclick = function() {
                    closeModal('advanceStatusConfirmModal');
                    closeModal('repaymentModal');
                    // 切换到项目垫资页面并打开第一个未审核记录的审核模态框
                    showPage('advanceFundingPage');
                    setTimeout(() => {
                        const firstRecordId = pendingRecords[0].recordId;
                        // 直接打开审核模态框
                        if (typeof openAuditModal === 'function') {
                            openAuditModal(firstRecordId);
                        } else {
                            // 如果openAuditModal不可用，则滚动到记录位置并高亮
                            const rows = document.querySelectorAll('#advanceFundingTableBody tr');
                            for (let row of rows) {
                                const cells = row.querySelectorAll('td');
                                if (cells.length > 0 && cells[0].textContent.trim() === firstRecordId) {
                                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    row.style.background = '#fff3cd';
                                    setTimeout(() => { row.style.background = ''; }, 2000);
                                    break;
                                }
                            }
                        }
                    }, 300);
                };
            } else {
                // 没有垫资记录
                messageEl.textContent = `该项目未申请垫资，请先申请垫资后再进行${repaymentType === 'airdrop' ? '空投归集' : '项目还款'}操作。`;
                pendingRecordsEl.style.display = 'none';
                
                verifyBtn.textContent = '去申请垫资';
                verifyBtn.onclick = function() {
                    closeModal('advanceStatusConfirmModal');
                    closeModal('repaymentModal');
                    // 打开申请垫资模态框，并预填项目信息
                    setTimeout(() => {
                        openModal('advanceModal');
                        const mainProjectSelect = document.getElementById('advanceMainProject');
                        const subProjectSelect = document.getElementById('advanceSubProject');
                        if (mainProjectSelect && subProjectSelect) {
                            mainProjectSelect.value = mainProject;
                            if (typeof updateAdvanceSubProjects === 'function') {
                                updateAdvanceSubProjects();
                                setTimeout(() => {
                                    subProjectSelect.value = subProject;
                                }, 100);
                            }
                        }
                    }, 100);
                };
            }
            
            // 存储回调函数
            pendingRepaymentData = {
                mainProject: mainProject,
                subProject: subProject,
                repaymentType: repaymentType,
                callback: callback
            };
            
            openModal('advanceStatusConfirmModal');
        }

        // 关闭垫资状态确认对话框并继续执行
        function closeAdvanceStatusConfirmModal() {
            closeModal('advanceStatusConfirmModal');
            if (pendingRepaymentData && pendingRepaymentData.callback) {
                pendingRepaymentData.callback();
            }
            pendingRepaymentData = null;
        }

        // 处理去核验按钮点击
        function handleAdvanceStatusVerify() {
            // 这个函数已经在openAdvanceStatusConfirmModal中动态设置了onclick
            // 这里保留作为备用
        }

        // 取消/撤回记录
        function cancelRecord(recordId) {
            const tbody = document.getElementById('advanceFundingTableBody');
            if (!tbody) return;
            
            const rows = tbody.querySelectorAll('tr');
            for (let row of rows) {
                const cells = row.querySelectorAll('td');
                if (cells.length < 15) continue;
                
                const rowRecordId = cells[0]?.textContent.trim();
                if (rowRecordId !== recordId) continue;
                
                // 找到对应的行，检查状态
                const statusCell = cells[8]; // 状态列
                const statusBadge = statusCell?.querySelector('.badge');
                if (!statusBadge) return;
                
                const currentStatus = statusBadge.textContent.trim();
                
                if (currentStatus === '待审核') {
                    // 待审核状态：可以取消
                    statusBadge.textContent = '已取消';
                    statusBadge.style.background = '#909399';
                    statusBadge.style.color = 'white';
                    
                    // 更新审核人和审核时间（如果有对应的单元格）
                    const approverCell = cells[11]; // 审核人列
                    const approveTimeCell = cells[12]; // 审核时间列
                    if (approverCell) approverCell.textContent = '当前用户';
                    if (approveTimeCell) approveTimeCell.textContent = formatDateTime();
                    
                    // 更新操作列：隐藏审核按钮，更新取消按钮的onclick
                    const operationCell = cells[14];
                    if (operationCell) {
                        const auditBtn = operationCell.querySelector('.link-btn[onclick*="openAuditModal"]');
                        if (auditBtn) auditBtn.style.display = 'none';
                        
                        // 确保取消按钮有onclick事件（如果还没有）
                        const cancelBtn = operationCell.querySelector('.link-btn:last-child');
                        if (cancelBtn && !cancelBtn.getAttribute('onclick')) {
                            cancelBtn.setAttribute('onclick', `event.stopPropagation(); cancelRecord('${recordId}')`);
                        }
                    }
                    
                    alert('操作已取消');
                } else if (currentStatus === '已审核') {
                    // 已审核状态：无法取消
                    alert('操作已进行，无法取消。如需资金划转，请申请新操作。');
                } else if (currentStatus === '已取消') {
                    // 已经是取消状态
                    alert('该操作已取消');
                }
                break;
            }
        }

        // 提交还款申请
        function submitRepayment() {
            const repaymentType = document.querySelector('input[name="repaymentType"]:checked').value;
            const mainProject = document.getElementById('repaymentMainProject').value;
            const subProject = document.getElementById('repaymentSubProject').value;
            const chain = document.getElementById('repaymentChain').value;
            const coin = document.getElementById('repaymentCoin').value;
            const amount = document.getElementById('repaymentAmount').value;
            const item = document.getElementById('repaymentItem').value.trim();
            const remark = document.getElementById('repaymentRemark').value.trim();

            if (!mainProject || !subProject || !chain || !coin || !amount) {
                alert('请填写必填项');
                return;
            }

            // 检查项目是否有已审核的垫资记录
            const hasApproved = hasApprovedAdvance(mainProject, subProject);
            if (!hasApproved) {
                // 没有已审核的垫资记录，显示确认对话框
                openAdvanceStatusConfirmModal(mainProject, subProject, repaymentType, function() {
                    // 用户确认继续后的回调函数
                    doSubmitRepayment(repaymentType, mainProject, subProject, chain, coin, amount, item, remark);
                });
                return;
            }

            // 如果有已审核的垫资记录，直接提交
            doSubmitRepayment(repaymentType, mainProject, subProject, chain, coin, amount, item, remark);
        }

        // 实际执行还款提交的函数
        function doSubmitRepayment(repaymentType, mainProject, subProject, chain, coin, amount, item, remark) {
            // 如果是空投归集，检查非稳定币债务
            if (repaymentType === 'airdrop') {
                const debts = calculateNonStableCoinDebt(mainProject, subProject);
                if (Object.keys(debts).length > 0) {
                    const debtDescription = getDebtDescription(debts, mainProject, subProject);
                    alert(`无法申请空投收益！\n\n该项目存在未归还的非稳定币债务：\n${debtDescription}\n\n请先归还所有非稳定币债务后，再申请空投收益。`);
                    return;
                }
            }

            // 添加到列表
            const recordId = generateRecordId();
            const applyTime = formatDateTime();
            const typeName = repaymentType === 'airdrop' ? '空投归集' : '项目还款';
            const defaultItem = repaymentType === 'airdrop' ? '空投收益归集' : '项目还款';
            
            const tbody = document.getElementById('advanceFundingTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${recordId}</td>
                <td>${item || defaultItem}</td>
                <td>${mainProject}</td>
                <td>${subProject}</td>
                <td>${coin.toLowerCase()}</td>
                <td class="text-right">${parseFloat(amount).toLocaleString()}</td>
                <td>${chain.toLowerCase()}</td>
                <td>${typeName}</td>
                <td class="text-center"><span class="badge" style="background: #e6a23c; color: white;">待审核</span></td>
                <td>当前用户</td>
                <td>${applyTime}</td>
                <td>-</td>
                <td>-</td>
                <td>${remark || '-'}</td>
                <td class="text-center">
                    <span class="link-btn" onclick="event.stopPropagation(); openAuditModal('${recordId}')" style="margin-right: 10px; color: #409eff;">审核</span>
                    <span class="link-btn" onclick="event.stopPropagation(); openModal('repaymentModal', '${mainProject}', '${subProject}')" style="margin-right: 10px;">申请还款/空投</span>
                    <span class="link-btn" onclick="event.stopPropagation(); cancelRecord('${recordId}')">取消</span>
                </td>
            `;
            tbody.insertBefore(newRow, tbody.firstChild);

            alert(`${typeName}申请提交成功！等待审核。`);
            closeModal('repaymentModal');
            
            // 注意：这里不更新资金池，因为记录还未审核
            // 只有在审核通过后才会更新
            
            // 清空表单并重置
            document.getElementById('repaymentMainProject').value = '';
            document.getElementById('repaymentSubProject').innerHTML = '<option value="">请先选择主项目</option>';
            document.getElementById('repaymentChain').value = '';
            document.getElementById('repaymentCoin').value = '';
            document.getElementById('repaymentAmount').value = '';
            document.getElementById('repaymentItem').value = '';
            document.getElementById('repaymentRemark').value = '';
            document.querySelector('#repaymentType1').checked = true;
            toggleRepaymentType();
            const repaymentDebtCheck = document.getElementById('repaymentDebtCheck');
            if (repaymentDebtCheck) {
                repaymentDebtCheck.style.display = 'none';
                repaymentDebtCheck.innerHTML = '';
            }
            const airdropDebtCheck = document.getElementById('repaymentAirdropDebtCheck');
            if (airdropDebtCheck) {
                airdropDebtCheck.style.display = 'none';
                airdropDebtCheck.innerHTML = '';
            }
        }


        // 点击模态框外部关闭
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        });

        // 阻止模态框内容区域的点击事件冒泡
        document.querySelectorAll('.modal-content').forEach(content => {
            content.addEventListener('click', function(event) {
                event.stopPropagation();
            });
        });
    </script>
</body>
</html>

